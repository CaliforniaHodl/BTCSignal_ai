<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Manager Demo - BTC Signals Pro</title>
  <style>
    :root {
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --border-color: #30363d;
      --text-primary: #e6edf3;
      --text-secondary: #8d96a0;
      --text-muted: #7d8590;
      --bitcoin-orange: #f7931a;
      --bullish: #3fb950;
      --bearish: #f85149;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: var(--bitcoin-orange);
      text-align: center;
      margin-bottom: 30px;
    }

    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .price-display {
      font-size: 3rem;
      font-weight: 700;
      text-align: center;
      margin: 20px 0;
      transition: color 0.3s ease;
    }

    .price-display.flash {
      animation: price-flash 0.5s ease;
    }

    @keyframes price-flash {
      0%, 100% {
        color: var(--text-primary);
      }
      50% {
        color: var(--bitcoin-orange);
        transform: scale(1.05);
      }
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .metric-row:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .metric-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status.connected {
      background: rgba(63, 185, 80, 0.1);
      color: var(--bullish);
      border: 1px solid rgba(63, 185, 80, 0.3);
    }

    .status.connecting {
      background: rgba(247, 147, 26, 0.1);
      color: var(--bitcoin-orange);
      border: 1px solid rgba(247, 147, 26, 0.3);
    }

    .status.failed {
      background: rgba(248, 81, 73, 0.1);
      color: var(--bearish);
      border: 1px solid rgba(248, 81, 73, 0.3);
    }

    .status.connected::before {
      content: "●";
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      background: var(--bitcoin-orange);
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(247, 147, 26, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.secondary {
      background: var(--bg-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .log {
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--text-muted);
      margin-right: 10px;
    }

    .positive {
      color: var(--bullish);
    }

    .negative {
      color: var(--bearish);
    }

    .subscriber-count {
      color: var(--bitcoin-orange);
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebSocket Manager Demo</h1>

    <div class="demo-grid">
      <!-- Live Price Card -->
      <div class="card">
        <h2>Live BTC Price</h2>
        <div class="price-display" id="price-display">--</div>
        <div class="metric-row">
          <span class="metric-label">24h Change</span>
          <span class="metric-value" id="change-display">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">24h Volume</span>
          <span class="metric-value" id="volume-display">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Data Source</span>
          <span class="metric-value" id="source-display">--</span>
        </div>
      </div>

      <!-- Connection Status Card -->
      <div class="card">
        <h2>Connection Status</h2>
        <div style="text-align: center; margin: 20px 0;">
          <span class="status connecting" id="status-badge">Initializing</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">State</span>
          <span class="metric-value" id="state-display">disconnected</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Subscribers</span>
          <span class="metric-value subscriber-count" id="subscriber-count">0</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Updates Received</span>
          <span class="metric-value" id="update-count">0</span>
        </div>
        <div class="controls">
          <button id="connect-btn">Connect</button>
          <button id="disconnect-btn" class="secondary">Disconnect</button>
          <button id="reconnect-btn" class="secondary">Force Reconnect</button>
        </div>
      </div>

      <!-- Stats Card -->
      <div class="card">
        <h2>24h Stats</h2>
        <div class="metric-row">
          <span class="metric-label">High</span>
          <span class="metric-value" id="high-display">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Low</span>
          <span class="metric-value" id="low-display">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Open</span>
          <span class="metric-value" id="open-display">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Number of Trades</span>
          <span class="metric-value" id="trades-display">--</span>
        </div>
      </div>
    </div>

    <!-- Event Log -->
    <div class="card">
      <h2>Event Log</h2>
      <div class="log" id="event-log">
        <div class="log-entry">
          <span class="log-time">--:--:--</span>
          <span>Waiting for connection...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Load WebSocket Manager -->
  <script src="/src/js/websocket-manager.js"></script>

  <!-- Demo Script -->
  <script>
    (function() {
      'use strict';

      // UI Elements
      const priceDisplay = document.getElementById('price-display');
      const changeDisplay = document.getElementById('change-display');
      const volumeDisplay = document.getElementById('volume-display');
      const sourceDisplay = document.getElementById('source-display');
      const statusBadge = document.getElementById('status-badge');
      const stateDisplay = document.getElementById('state-display');
      const subscriberCount = document.getElementById('subscriber-count');
      const updateCount = document.getElementById('update-count');
      const highDisplay = document.getElementById('high-display');
      const lowDisplay = document.getElementById('low-display');
      const openDisplay = document.getElementById('open-display');
      const tradesDisplay = document.getElementById('trades-display');
      const eventLog = document.getElementById('event-log');

      const connectBtn = document.getElementById('connect-btn');
      const disconnectBtn = document.getElementById('disconnect-btn');
      const reconnectBtn = document.getElementById('reconnect-btn');

      let updateCounter = 0;
      let subscriberId = null;

      // Add log entry
      function addLog(message, type = 'info') {
        const now = new Date();
        const time = now.toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-time">${time}</span><span class="${type}">${message}</span>`;
        eventLog.insertBefore(entry, eventLog.firstChild);

        // Keep only last 50 entries
        while (eventLog.children.length > 50) {
          eventLog.removeChild(eventLog.lastChild);
        }
      }

      // Format currency
      function formatCurrency(value) {
        return '$' + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      // Format large number
      function formatLarge(value) {
        if (value >= 1e9) {
          return '$' + (value / 1e9).toFixed(2) + 'B';
        } else if (value >= 1e6) {
          return '$' + (value / 1e6).toFixed(2) + 'M';
        }
        return '$' + value.toLocaleString();
      }

      // Update connection status
      function updateStatus() {
        const state = WSManager.getConnectionState();
        stateDisplay.textContent = state;
        subscriberCount.textContent = WSManager.getSubscriberCount();

        // Update status badge
        statusBadge.className = 'status ' + state;
        switch(state) {
          case 'connected':
            statusBadge.textContent = 'Live';
            break;
          case 'connecting':
            statusBadge.textContent = 'Connecting...';
            break;
          case 'reconnecting':
            statusBadge.textContent = 'Reconnecting...';
            break;
          case 'failed':
            statusBadge.textContent = 'Failed (Using REST)';
            break;
          default:
            statusBadge.textContent = 'Offline';
        }
      }

      // Handle price updates
      function handlePriceUpdate(data) {
        // Handle state changes
        if (data.type === 'state') {
          addLog(`State changed: ${data.oldState} → ${data.newState}`, 'info');
          updateStatus();
          return;
        }

        // Update counter
        updateCounter++;
        updateCount.textContent = updateCounter.toLocaleString();

        // Update price with flash
        if (data.price) {
          priceDisplay.classList.remove('flash');
          void priceDisplay.offsetWidth; // Force reflow
          priceDisplay.classList.add('flash');
          priceDisplay.textContent = formatCurrency(data.price);
        }

        // Update 24h change
        if (data.priceChangePercent !== undefined) {
          const isPositive = data.priceChangePercent >= 0;
          const arrow = isPositive ? '▲' : '▼';
          const sign = isPositive ? '+' : '';
          changeDisplay.textContent = `${arrow} ${sign}${data.priceChangePercent.toFixed(2)}%`;
          changeDisplay.className = 'metric-value ' + (isPositive ? 'positive' : 'negative');
        }

        // Update volume
        if (data.quoteVolume24h) {
          volumeDisplay.textContent = formatLarge(data.quoteVolume24h);
        }

        // Update source
        sourceDisplay.textContent = data.source === 'websocket' ? 'WebSocket (Live)' : 'REST API (Fallback)';

        // Update stats
        if (data.high24h) highDisplay.textContent = formatCurrency(data.high24h);
        if (data.low24h) lowDisplay.textContent = formatCurrency(data.low24h);
        if (data.openPrice) openDisplay.textContent = formatCurrency(data.openPrice);
        if (data.numberOfTrades) tradesDisplay.textContent = data.numberOfTrades.toLocaleString();

        // Log update
        if (updateCounter % 10 === 0) {
          addLog(`Received ${updateCounter} updates - Price: ${formatCurrency(data.price)}`, 'info');
        }
      }

      // Button handlers
      connectBtn.addEventListener('click', () => {
        if (subscriberId === null) {
          subscriberId = WSManager.subscribe(handlePriceUpdate);
          addLog('Subscribed to price updates', 'positive');
          updateStatus();
        }
        if (!WSManager.isConnected()) {
          WSManager.connect();
          addLog('Connection initiated', 'info');
        }
      });

      disconnectBtn.addEventListener('click', () => {
        if (subscriberId !== null) {
          WSManager.unsubscribe(subscriberId);
          subscriberId = null;
          addLog('Unsubscribed from price updates', 'info');
        }
        WSManager.disconnect();
        addLog('Disconnected', 'negative');
        updateStatus();
      });

      reconnectBtn.addEventListener('click', () => {
        WSManager.forceReconnect();
        addLog('Force reconnect requested', 'info');
        updateStatus();
      });

      // Initialize
      addLog('Demo initialized. Click Connect to start.', 'positive');
      updateStatus();

      // Auto-connect after 1 second
      setTimeout(() => {
        connectBtn.click();
      }, 1000);
    })();
  </script>
</body>
</html>
