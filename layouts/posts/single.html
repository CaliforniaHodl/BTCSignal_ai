{{ define "main" }}
{{/* Determine if this post is in the latest 3 (free) or paywalled */}}
{{ $latestPosts := first 10 (where .Site.RegularPages "Section" "posts") }}
{{ $isFree := true }}
{{ range $latestPosts }}
  {{ if eq $.Permalink .Permalink }}
    {{ $isFree = false }}
  {{ end }}
{{ end }}

<div class="container single-post-page" data-post-id="{{ .File.UniqueID }}" data-is-free="{{ $isFree }}">
  <nav class="breadcrumb">
    <a href="/">Home</a>
    <span class="separator">/</span>
    <a href="/posts/">Analysis</a>
    <span class="separator">/</span>
    <span class="current">{{ .Date.Format "Jan 02, 2006 15:04" }}</span>
  </nav>

  <article class="analysis-article">
    <header class="article-header">
      <div class="header-meta">
        <span class="date">{{ .Date.Format "January 02, 2006" }}</span>
        <span class="time">{{ .Date.Format "15:04" }} UTC</span>
        <span class="timeframe-badge">{{ .Params.timeframe }}</span>
      </div>

      <h1 class="article-title">{{ .Params.symbol }} Analysis</h1>

      <div class="quick-stats">
        <div class="stat sentiment {{ .Params.sentiment }}">
          <span class="stat-label">Sentiment</span>
          <span class="stat-value">
            {{ if eq .Params.sentiment "bullish" }}üìà{{ else if eq .Params.sentiment "bearish" }}üìâ{{ else }}‚è∏Ô∏è{{ end }}
            {{ upper .Params.sentiment }}
          </span>
        </div>
        <div class="stat confidence">
          <span class="stat-label">Confidence</span>
          <span class="stat-value">{{ .Params.confidence }}%</span>
        </div>
        <div class="stat price">
          <span class="stat-label">Price</span>
          <span class="stat-value">${{ .Params.price }}</span>
        </div>
        <div class="stat change {{ if hasPrefix .Params.priceChange "+" }}positive{{ else }}negative{{ end }}">
          <span class="stat-label">Change</span>
          <span class="stat-value">{{ .Params.priceChange }}</span>
        </div>
      </div>

      {{ if or .Params.targetPrice .Params.stopLoss }}
      <div class="targets">
        {{ if .Params.targetPrice }}
        <div class="target-item target">
          <span class="target-label">Target</span>
          <span class="target-value">${{ .Params.targetPrice }}</span>
        </div>
        {{ end }}
        {{ if .Params.stopLoss }}
        <div class="target-item stop-loss">
          <span class="target-label">Stop Loss</span>
          <span class="target-value">${{ .Params.stopLoss }}</span>
        </div>
        {{ end }}
      </div>
      {{ end }}
    </header>

    {{/* Paywall overlay for non-free posts */}}
    {{ if not $isFree }}
    <div class="paywall-overlay" id="paywall-overlay">
      <div class="paywall-content">
        <div class="lightning-icon">‚ö°</div>
        <h3>Premium Analysis</h3>
        <p>Unlock this analysis for <strong>21 sats</strong></p>
        <div id="invoice-container" style="display: none;">
          <div id="qr-code"></div>
          <div class="invoice-string">
            <input type="text" id="invoice-string" readonly>
            <button id="copy-invoice" class="btn-copy">Copy</button>
          </div>
          <p class="waiting-text">Waiting for payment...</p>
        </div>
        <button id="unlock-btn" class="btn-lightning">
          <span>‚ö°</span> Pay with Lightning
        </button>
        <p class="paywall-note">Instant unlock via Bitcoin Lightning Network</p>
      </div>
    </div>
    {{ end }}

    <div class="article-content {{ if not $isFree }}blurred{{ end }}" id="article-content">
      {{ .Content }}
    </div>

    <footer class="article-footer">
      <a href="/posts/" class="back-link">‚Üê Back to all analysis</a>
    </footer>
  </article>
</div>

{{ if not $isFree }}
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="{{ "src/js/paywall.js" | relURL }}"></script>
{{ end }}
{{ end }}
