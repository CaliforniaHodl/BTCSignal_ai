{{ define "main" }}
<div class="container posts-page">
  <header class="page-header">
    <h1>Analysis History</h1>
    <p class="page-description">Bitcoin technical analysis powered by AI</p>
  </header>

  <!-- Desktop Table View -->
  <div class="posts-table-container d-none d-md-block">
    <table class="posts-table">
      <thead>
        <tr>
          <th class="col-date">Date</th>
          <th class="col-time">Time</th>
          <th class="col-sentiment">Sentiment</th>
          <th class="col-confidence">Confidence</th>
          <th class="col-price">Price</th>
          <th class="col-change">Change</th>
          <th class="col-action"></th>
        </tr>
      </thead>
      <tbody>
        {{ $pages := .Pages.ByDate.Reverse }}
        {{ range $index, $post := $pages }}
        {{ $isLocked := lt $index 10 }}
        <tr class="post-row {{ $post.Params.direction }}{{ if $isLocked }} locked{{ end }}">
          <td class="col-date">{{ $post.Date.Format "Jan 02, 2006" }}</td>
          <td class="col-time">{{ $post.Date.Format "15:04" }} UTC</td>
          <td class="col-sentiment">
            <span class="sentiment-badge {{ $post.Params.direction }}">
              {{ if eq $post.Params.direction "up" }}
                <span class="emoji">üìà</span> BULLISH
              {{ else if eq $post.Params.direction "down" }}
                <span class="emoji">üìâ</span> BEARISH
              {{ else }}
                <span class="emoji">‚è∏Ô∏è</span> NEUTRAL
              {{ end }}
            </span>
          </td>
          <td class="col-confidence">
            <div class="confidence-wrapper">
              <span class="confidence-value">{{ $post.Params.confidence }}%</span>
              <div class="confidence-bar">
                <div class="confidence-fill" style="width: {{ $post.Params.confidence }}%"></div>
              </div>
            </div>
          </td>
          <td class="col-price">${{ printf "%.2f" $post.Params.price }}</td>
          <td class="col-change {{ if $post.Params.priceChange }}{{ if hasPrefix $post.Params.priceChange "+" }}positive{{ else }}negative{{ end }}{{ end }}">
            {{ $post.Params.priceChange | default "--" }}
          </td>
          <td class="col-action">
            {{ if $isLocked }}
            <a href="{{ $post.Permalink }}" class="lock-btn">üîí Unlock</a>
            {{ else }}
            <a href="{{ $post.Permalink }}" class="view-btn">View</a>
            {{ end }}
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>

  <!-- Mobile Card View -->
  <div class="posts-cards-container d-md-none">
    {{ $pages := .Pages.ByDate.Reverse }}
    {{ $totalPosts := len $pages }}
    {{ range $index, $post := $pages }}
    {{ $isLocked := lt $index 10 }}
    {{ $lazyClass := "" }}
    {{ if ge $index 8 }}{{ if lt $index 20 }}{{ $lazyClass = "lazy-post" }}{{ end }}{{ end }}
    {{ if ge $index 20 }}{{ $lazyClass = "paginated-post" }}{{ end }}
    <a href="{{ $post.Permalink }}" class="post-card {{ $post.Params.direction }}{{ if $isLocked }} locked{{ end }}{{ if $lazyClass }} {{ $lazyClass }}{{ end }}" data-index="{{ $index }}">
      <div class="post-card-header">
        <span class="post-date">{{ $post.Date.Format "Jan 02, 15:04" }}</span>
        {{ if $isLocked }}
        <span class="lock-badge">üîí 21 sats</span>
        {{ else }}
        <span class="free-badge">‚úì Free</span>
        {{ end }}
      </div>
      <div class="post-card-body">
        <span class="direction-badge {{ $post.Params.direction }}">
          {{ if eq $post.Params.direction "up" }}üìà BULLISH{{ else if eq $post.Params.direction "down" }}üìâ BEARISH{{ else }}‚è∏Ô∏è NEUTRAL{{ end }}
        </span>
        <span class="confidence">
          <span class="confidence-label">Confidence</span>
          <span class="confidence-value">{{ $post.Params.confidence }}%</span>
        </span>
      </div>
      <div class="post-card-footer">
        <span class="price">${{ printf "%.2f" $post.Params.price }}</span>
        {{ if $post.Params.priceChange }}
        <span class="change {{ if hasPrefix $post.Params.priceChange "+" }}positive{{ else }}negative{{ end }}">{{ $post.Params.priceChange }}</span>
        {{ end }}
      </div>
    </a>
    {{ end }}

    <!-- Load More Button (shows after initial 8, loads up to 20) -->
    {{ if gt $totalPosts 8 }}
    <button class="load-more-btn" id="load-more-btn">Load More</button>
    {{ end }}

    <!-- Pagination (shows after 20 posts are visible) -->
    {{ if gt $totalPosts 20 }}
    <div class="posts-pagination" id="posts-pagination">
      <span class="pagination-info">Showing <span id="shown-count">20</span> of {{ $totalPosts }}</span>
      <button class="pagination-btn" id="load-next-page">Load Next 20</button>
    </div>
    {{ end }}
  </div>

  <script>
  (function() {
    // Only run on mobile
    if (window.innerWidth >= 768) return;

    const lazyPosts = document.querySelectorAll('.lazy-post');
    const paginatedPosts = document.querySelectorAll('.paginated-post');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const pagination = document.getElementById('posts-pagination');
    const loadNextBtn = document.getElementById('load-next-page');
    const shownCount = document.getElementById('shown-count');

    let lazyLoaded = false;
    let currentPage = 0;
    const postsPerPage = 20;

    // Hide lazy posts and paginated posts initially
    lazyPosts.forEach(p => p.style.display = 'none');
    paginatedPosts.forEach(p => p.style.display = 'none');
    if (pagination) pagination.style.display = 'none';

    // Load More button - reveals posts 9-20
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', function() {
        lazyPosts.forEach(p => p.style.display = '');
        loadMoreBtn.style.display = 'none';
        lazyLoaded = true;
        if (pagination && paginatedPosts.length > 0) {
          pagination.style.display = 'flex';
        }
      });
    }

    // Pagination - loads next 20 posts
    if (loadNextBtn) {
      loadNextBtn.addEventListener('click', function() {
        const start = currentPage * postsPerPage;
        const end = start + postsPerPage;
        let shown = 0;

        paginatedPosts.forEach((p, i) => {
          if (i >= start && i < end) {
            p.style.display = '';
            shown++;
          }
        });

        currentPage++;
        const totalShown = 20 + (currentPage * postsPerPage);
        if (shownCount) shownCount.textContent = Math.min(totalShown, 20 + paginatedPosts.length);

        // Hide button if no more posts
        if (end >= paginatedPosts.length) {
          loadNextBtn.style.display = 'none';
        }
      });
    }
  })();
  </script>

  {{ if eq (len .Pages) 0 }}
  <div class="empty-state">
    <p>No analysis posts yet. The bot will start posting hourly analysis soon.</p>
  </div>
  {{ end }}
</div>
{{ end }}
