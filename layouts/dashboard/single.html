{{ define "main" }}
<div class="container dashboard-page" id="dashboard-container">
  <!-- Paywall check - show content only if user has paid -->
  <div class="dashboard-locked" id="dashboard-locked">
    <div class="lock-message">
      <div class="lightning-icon">üîí</div>
      <h2>Premium Dashboard</h2>
      <p>Get access to advanced trading tools and real-time market data</p>
      <a href="/pricing/" class="btn-lightning">View Pricing</a>
    </div>
  </div>

  <div class="dashboard-content" id="dashboard-content" style="display: none;">
    <header class="dashboard-header">
      <h1>Pro Trading Dashboard</h1>
      <p class="subtitle">Real-time market intelligence & performance analytics</p>
      <div class="dashboard-header-actions">
        <a href="/chart-demo/" class="btn-chart-link">
          <i class="fas fa-chart-line" aria-hidden="true"></i> Open Interactive Chart
        </a>
        <button id="btn-export-csv" class="btn-export" aria-label="Export market data as CSV">
          <i class="fas fa-download" aria-hidden="true"></i> Export CSV
        </button>
      </div>
      <!-- Data Cache Status Indicator -->
      <div class="cache-status" id="cache-status">
        <span class="cache-dot" id="cache-dot"></span>
        <span class="cache-text" id="cache-text">Checking data freshness...</span>
        <span class="cache-time" id="cache-time"></span>
      </div>
    </header>

    <!-- Market Sentiment Grid - Market Sentiment Style Widgets (3x more) -->
    <section class="dashboard-widgets">
      <h2>Market Intelligence</h2>
      <p class="section-desc">Real-time sentiment indicators and market metrics</p>
      <div class="dashboard-grid">
        <!-- Fear & Greed Widget -->
        <div class="widget-card widget-fng">
          <div class="widget-header">
            <span class="widget-icon">üò±</span>
            <h3>Fear & Greed Index</h3>
            {{ partial "tooltip.html" (dict "text" "Measures market sentiment from 0 (Extreme Fear) to 100 (Extreme Greed). Extreme fear can indicate buying opportunities, while extreme greed may signal an overheated market.") }}
          </div>
          <div class="widget-value" id="dash-fng-value"><span class="skeleton-stat"></span></div>
          <div class="widget-label" id="dash-fng-label"><span class="skeleton-text skeleton-text-sm"></span></div>
          <div class="widget-chart">
            <div class="fng-gradient-bar">
              <div class="fng-indicator" id="dash-fng-indicator" style="left: 50%"></div>
            </div>
          </div>
        </div>

        <!-- Funding Rate Widget -->
        <div class="widget-card widget-funding">
          <div class="widget-header">
            <span class="widget-icon">üí∞</span>
            <h3>BTC Funding Rate</h3>
            {{ partial "tooltip.html" (dict "text" "Perpetual futures funding rate. Positive = longs pay shorts (bullish market). Negative = shorts pay longs (bearish). Extreme rates often precede reversals.") }}
          </div>
          <div class="widget-value" id="dash-funding-value"><span class="skeleton-stat"></span></div>
          <div class="widget-label" id="dash-funding-label"><span class="skeleton-text skeleton-text-sm"></span></div>
          <div class="widget-sublabel">8h perpetual rate</div>
        </div>

        <!-- Open Interest Widget -->
        <div class="widget-card widget-volume">
          <div class="widget-header">
            <span class="widget-icon">üìä</span>
            <h3>Open Interest</h3>
            {{ partial "tooltip.html" (dict "text" "Total value of outstanding futures contracts. Rising OI = new money entering. Falling OI = positions closing. OI + price divergence signals trend weakness.") }}
          </div>
          <div class="widget-value" id="dash-oi-value">--</div>
          <div class="widget-label" id="dash-oi-change">Loading...</div>
          <div class="widget-sublabel">Total leveraged positions</div>
        </div>

        <!-- Buy/Sell Volume Widget -->
        <div class="widget-card widget-signals">
          <div class="widget-header">
            <span class="widget-icon">‚öñÔ∏è</span>
            <h3>Buy/Sell Ratio</h3>
            {{ partial "tooltip.html" (dict "text" "Taker buy vs sell volume ratio. >1 = more aggressive buying. <1 = more aggressive selling. Measures real-time market aggression and momentum.") }}
          </div>
          <div class="widget-value" id="dash-ratio-value">--</div>
          <div class="widget-label" id="dash-ratio-label">Loading...</div>
          <div class="widget-chart">
            <div class="vol-bar-container" id="dash-vol-bars">
              <div class="vol-bar buy" style="width: 50%"></div>
              <div class="vol-bar sell" style="width: 50%"></div>
            </div>
          </div>
        </div>

        <!-- Long/Short Ratio Widget -->
        <div class="widget-card widget-performance">
          <div class="widget-header">
            <span class="widget-icon">üìà</span>
            <h3>Long/Short Ratio</h3>
            {{ partial "tooltip.html" (dict "text" "Shows the ratio of traders holding long vs short positions. A ratio > 1 means more longs. Data from Bybit.") }}
          </div>
          <div class="widget-value" id="dash-ls-value">--</div>
          <div class="widget-label" id="dash-ls-label">Loading...</div>
          <div class="widget-chart">
            <div class="ls-bar-container">
              <div class="ls-bar long" id="dash-ls-long-bar" style="width: 50%">
                <span class="ls-bar-label" id="dash-ls-long-pct">50%</span>
              </div>
              <div class="ls-bar short" id="dash-ls-short-bar" style="width: 50%">
                <span class="ls-bar-label" id="dash-ls-short-pct">50%</span>
              </div>
            </div>
            <div class="ls-labels">
              <span class="long-label">Long</span>
              <span class="short-label">Short</span>
            </div>
          </div>
          <div class="widget-sublabel">Top traders positioning (Bybit)</div>
        </div>

        <!-- Liquidations 24h Widget -->
        <div class="widget-card widget-liquidation">
          <div class="widget-header">
            <span class="widget-icon">üî•</span>
            <h3>24h Liquidations</h3>
            {{ partial "tooltip.html" (dict "text" "Forced position closures in last 24h. High liquidations = overleveraged market. Long liquidations dominate in downtrends, short liquidations in uptrends.") }}
          </div>
          <div class="widget-value" id="dash-liq-value">--</div>
          <div class="widget-label" id="dash-liq-label">Loading...</div>
          <div class="widget-sublabel">Long vs Short breakdown</div>
        </div>

        <!-- RSI Widget -->
        <div class="widget-card widget-patterns">
          <div class="widget-header">
            <span class="widget-icon">üìâ</span>
            <h3>RSI (14)</h3>
            {{ partial "tooltip.html" (dict "text" "Relative Strength Index measures momentum. <30 = oversold (potential bounce). >70 = overbought (potential pullback). RSI divergence from price often signals reversals.") }}
          </div>
          <div class="widget-value" id="dash-rsi-value">--</div>
          <div class="widget-label" id="dash-rsi-label">Loading...</div>
          <div class="widget-sublabel">4H timeframe</div>
        </div>

        <!-- Volatility Widget -->
        <div class="widget-card widget-alerts">
          <div class="widget-header">
            <span class="widget-icon">‚ö°</span>
            <h3>Volatility Index</h3>
            {{ partial "tooltip.html" (dict "text" "24-hour price range as percentage. Low volatility periods often precede big moves. High volatility = active market but higher risk for leveraged trades.") }}
          </div>
          <div class="widget-value" id="dash-vol-value">--</div>
          <div class="widget-label" id="dash-vol-label">Loading...</div>
          <div class="widget-sublabel">24h price range %</div>
        </div>

        <!-- Dominance Widget -->
        <div class="widget-card widget-calendar">
          <div class="widget-header">
            <span class="widget-icon">üëë</span>
            <h3>BTC Dominance</h3>
            {{ partial "tooltip.html" (dict "text" "Bitcoin's share of total crypto market cap. Rising dominance = flight to BTC safety. Falling dominance = altcoin season. Key levels: 40-45% (alt season) and 55%+ (BTC strength).") }}
          </div>
          <div class="widget-value" id="dash-dom-value">--</div>
          <div class="widget-label" id="dash-dom-label">Loading...</div>
          <div class="widget-sublabel">Market share</div>
        </div>
      </div>
    </section>

    <!-- Open Interest History Section -->
    <section class="oi-history-section">
      <h2>Open Interest Analysis</h2>
      <p class="section-desc">Track aggregate OI across exchanges with price overlay. Rising OI + rising price = strong trend.</p>

      <div class="oi-grid">
        <!-- OI Stats Cards -->
        <div class="oi-stats-row">
          <div class="oi-stat-card">
            <span class="oi-stat-label">Total OI (BTC)</span>
            <span class="oi-stat-value" id="oi-total-btc">--</span>
          </div>
          <div class="oi-stat-card">
            <span class="oi-stat-label">Total OI (USD)</span>
            <span class="oi-stat-value" id="oi-total-usd">--</span>
          </div>
          <div class="oi-stat-card">
            <span class="oi-stat-label">24h Change</span>
            <span class="oi-stat-value" id="oi-change-24h">--</span>
          </div>
          <div class="oi-stat-card">
            <span class="oi-stat-label">OI/MCap Ratio</span>
            <span class="oi-stat-value" id="oi-mcap-ratio">--</span>
            {{ partial "tooltip.html" (dict "text" "Open Interest as % of Market Cap. Higher = more leveraged market.") }}
          </div>
        </div>

        <!-- OI History Chart with Price Overlay -->
        <div class="oi-chart-card">
          <div class="oi-chart-header">
            <span class="oi-chart-icon">üìä</span>
            <h3>30-Day OI & Price</h3>
          </div>
          <div class="oi-chart-container">
            <canvas id="oiHistoryChart" height="250"></canvas>
          </div>
          <div class="oi-chart-legend">
            <span class="legend-oi"><span class="legend-dot oi"></span> Open Interest</span>
            <span class="legend-price"><span class="legend-dot price"></span> BTC Price</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Multi-Exchange Funding Rate Comparison -->
    <section class="funding-comparison-section">
      <h2>Multi-Exchange Funding Rates</h2>
      <p class="section-desc">Compare perpetual funding rates across major exchanges. Spread >0.02% may indicate arbitrage opportunities.</p>

      <div class="funding-grid">
        <!-- Funding Comparison Table -->
        <div class="funding-card funding-table-card">
          <div class="funding-card-header">
            <span class="funding-card-icon">üí∞</span>
            <h3>Exchange Comparison</h3>
          </div>
          <div class="funding-table-wrapper">
            <table class="funding-table" id="funding-comparison-table">
              <thead>
                <tr>
                  <th>Exchange</th>
                  <th>Current Rate</th>
                  <th>8h Trend</th>
                  <th>Annualized</th>
                  <th>Next Funding</th>
                </tr>
              </thead>
              <tbody id="funding-table-body">
                <tr><td colspan="5" class="loading-row">Loading exchange data...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="funding-arbitrage" id="funding-arbitrage">
            <span class="arbitrage-label">Max Spread:</span>
            <span class="arbitrage-value" id="funding-spread">--</span>
            <span class="arbitrage-opportunity" id="funding-opportunity"></span>
          </div>
        </div>

        <!-- Funding Rate History Chart -->
        <div class="funding-card funding-history-card">
          <div class="funding-card-header">
            <span class="funding-card-icon">üìà</span>
            <h3>30-Day Funding History</h3>
          </div>
          <div class="funding-chart-container">
            <canvas id="fundingHistoryChart" height="200"></canvas>
          </div>
          <div class="funding-stats">
            <div class="funding-stat">
              <span class="stat-label">Avg Rate (30d)</span>
              <span class="stat-value" id="funding-avg-30d">--</span>
            </div>
            <div class="funding-stat">
              <span class="stat-label">Positive Days</span>
              <span class="stat-value positive" id="funding-positive-days">--</span>
            </div>
            <div class="funding-stat">
              <span class="stat-label">Current Streak</span>
              <span class="stat-value" id="funding-streak">--</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Funding Rate Arbitrage Calculator -->
    <section class="arbitrage-calculator-section">
      <h2>Funding Arbitrage Calculator</h2>
      <p class="section-desc">Calculate potential profits from funding rate spreads between exchanges. Go long on low-rate exchange, short on high-rate.</p>

      <div class="arbitrage-grid">
        <!-- Calculator Card -->
        <div class="arbitrage-card calculator-card">
          <div class="arbitrage-card-header">
            <span class="arbitrage-card-icon">üßÆ</span>
            <h3>Profit Calculator</h3>
          </div>

          <div class="arbitrage-form">
            <div class="arb-form-row">
              <div class="arb-form-group">
                <label>Position Size (USD)</label>
                <div class="arb-input-wrapper">
                  <span class="arb-prefix">$</span>
                  <input type="number" id="arb-position-size" value="10000" min="100" step="100">
                </div>
              </div>
              <div class="arb-form-group">
                <label>Holding Period</label>
                <select id="arb-period">
                  <option value="1">1 day (3x funding)</option>
                  <option value="7" selected>1 week (21x funding)</option>
                  <option value="30">30 days (90x funding)</option>
                </select>
              </div>
            </div>

            <div class="arb-exchanges">
              <div class="arb-exchange long-exchange">
                <label>Long Position Exchange</label>
                <select id="arb-long-exchange">
                  <option value="auto">Auto (Lowest Rate)</option>
                  <option value="bybit">Bybit</option>
                  <option value="okx">OKX</option>
                  <option value="dydx">dYdX</option>
                  <option value="bitget">Bitget</option>
                </select>
                <div class="exchange-rate" id="arb-long-rate">Rate: --</div>
              </div>
              <div class="arb-exchange-arrow">‚áÑ</div>
              <div class="arb-exchange short-exchange">
                <label>Short Position Exchange</label>
                <select id="arb-short-exchange">
                  <option value="auto">Auto (Highest Rate)</option>
                  <option value="bybit">Bybit</option>
                  <option value="okx">OKX</option>
                  <option value="dydx">dYdX</option>
                  <option value="bitget">Bitget</option>
                </select>
                <div class="exchange-rate" id="arb-short-rate">Rate: --</div>
              </div>
            </div>

            <button class="btn-calculate-arb" id="btn-calculate-arb">Calculate Profit</button>
          </div>

          <!-- Results -->
          <div class="arb-results" id="arb-results" style="display: none;">
            <div class="arb-result-row main-result">
              <span class="result-label">Estimated Profit</span>
              <span class="result-value profit" id="arb-profit">$0.00</span>
            </div>
            <div class="arb-result-row">
              <span class="result-label">Rate Spread</span>
              <span class="result-value" id="arb-spread-result">0.000%</span>
            </div>
            <div class="arb-result-row">
              <span class="result-label">Annualized Return</span>
              <span class="result-value" id="arb-annual-return">0.0%</span>
            </div>
            <div class="arb-result-row fees">
              <span class="result-label">Est. Trading Fees</span>
              <span class="result-value negative" id="arb-fees">-$0.00</span>
            </div>
            <div class="arb-result-row">
              <span class="result-label">Net Profit</span>
              <span class="result-value" id="arb-net-profit">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Info Card -->
        <div class="arbitrage-card info-card">
          <div class="arbitrage-card-header">
            <span class="arbitrage-card-icon">‚ÑπÔ∏è</span>
            <h3>How Funding Arbitrage Works</h3>
          </div>
          <div class="arb-info-content">
            <ol class="arb-steps">
              <li><strong>Open Long Position</strong> on the exchange with the lowest (or most negative) funding rate</li>
              <li><strong>Open Short Position</strong> on the exchange with the highest funding rate</li>
              <li><strong>Collect the Spread</strong> - You receive funding on the short while paying less on the long</li>
              <li><strong>Close Both Positions</strong> when the spread narrows or after your target period</li>
            </ol>
            <div class="arb-risk-warning">
              <span class="warning-icon">‚ö†Ô∏è</span>
              <p><strong>Risk Warning:</strong> Funding arbitrage involves execution risk, exchange risk, and requires maintaining margin on both exchanges. Rates can change rapidly. Not financial advice.</p>
            </div>
            <div class="arb-assumptions">
              <h4>Calculator Assumptions</h4>
              <ul>
                <li>Trading fees: 0.05% maker fee per trade (0.2% total round-trip)</li>
                <li>Funding paid/received every 8 hours</li>
                <li>Rates remain constant during holding period</li>
                <li>No slippage on entries/exits</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Advanced Derivatives Analysis (Phase 5) -->
    <section class="derivatives-advanced-section">
      <h2>Advanced Derivatives Analysis</h2>
      <p class="section-desc">Multi-exchange aggregated derivatives metrics with AI-powered sentiment analysis</p>

      <div class="derivatives-advanced-grid">
        <!-- Funding Rate Gauge -->
        <div id="deriv-funding-gauge" class="deriv-adv-widget">
          <div class="deriv-adv-loading">Loading funding rate data...</div>
        </div>

        <!-- Long/Short Ratio -->
        <div id="deriv-ls-ratio" class="deriv-adv-widget">
          <div class="deriv-adv-loading">Loading long/short ratio...</div>
        </div>

        <!-- Liquidations -->
        <div id="deriv-liquidations" class="deriv-adv-widget">
          <div class="deriv-adv-loading">Loading liquidation data...</div>
        </div>

        <!-- OI Delta -->
        <div id="deriv-oi-delta" class="deriv-adv-widget">
          <div class="deriv-adv-loading">Loading OI delta...</div>
        </div>

        <!-- Max Pain -->
        <div id="deriv-max-pain" class="deriv-adv-widget">
          <div class="deriv-adv-loading">Loading max pain...</div>
        </div>

        <!-- Implied Volatility -->
        <div id="deriv-iv" class="deriv-adv-widget">
          <div class="deriv-adv-loading">Loading IV data...</div>
        </div>

        <!-- Overall Sentiment -->
        <div id="deriv-overall-sentiment" class="deriv-adv-widget deriv-sentiment-widget">
          <div class="deriv-adv-loading">Calculating sentiment...</div>
        </div>
      </div>
    </section>

    <!-- On-Chain Metrics (Phase 6 Sprint 4) -->
    <section class="onchain-section">
      <h2>On-Chain Intelligence</h2>
      <p class="section-desc">Track exchange reserves, whale flows, and market valuation metrics for deeper market insights.</p>

      <div class="onchain-grid">
        <!-- Exchange Reserves Card -->
        <div class="onchain-card reserves-card">
          <div class="onchain-card-header">
            <span class="onchain-card-icon">üè¶</span>
            <h3>Exchange Reserves</h3>
            {{ partial "tooltip.html" (dict "text" "BTC held on exchanges. Decreasing reserves = accumulation (bullish). Increasing = distribution (bearish).") }}
          </div>

          <div class="reserves-main">
            <div class="reserves-total">
              <span class="reserves-value" id="reserves-total">--</span>
              <span class="reserves-label">BTC on Exchanges</span>
            </div>
            <div class="reserves-changes">
              <div class="reserves-change">
                <span class="change-label">24h</span>
                <span class="change-value" id="reserves-24h">--%</span>
              </div>
              <div class="reserves-change">
                <span class="change-label">7d</span>
                <span class="change-value" id="reserves-7d">--%</span>
              </div>
            </div>
          </div>

          <div class="reserves-trend" id="reserves-trend">
            <span class="trend-icon">--</span>
            <span class="trend-text">Loading...</span>
          </div>

          <div class="reserves-breakdown">
            <h4>Top Exchanges</h4>
            <div class="exchange-list" id="exchange-reserves-list">
              <div class="exchange-row loading">Loading exchange data...</div>
            </div>
          </div>
        </div>

        <!-- Whale Flows Card -->
        <div class="onchain-card whale-card">
          <div class="onchain-card-header">
            <span class="onchain-card-icon">üêã</span>
            <h3>Whale Flows (24h)</h3>
            {{ partial "tooltip.html" (dict "text" "Large BTC movements to/from exchanges. Net outflow = accumulation. Net inflow = selling pressure.") }}
          </div>

          <div class="whale-flows">
            <div class="flow-item inflow">
              <span class="flow-icon">üì•</span>
              <div class="flow-info">
                <span class="flow-label">Exchange Inflow</span>
                <span class="flow-value" id="whale-inflow">-- BTC</span>
              </div>
            </div>
            <div class="flow-item outflow">
              <span class="flow-icon">üì§</span>
              <div class="flow-info">
                <span class="flow-label">Exchange Outflow</span>
                <span class="flow-value" id="whale-outflow">-- BTC</span>
              </div>
            </div>
          </div>

          <div class="net-flow" id="net-flow">
            <span class="net-flow-label">Net Flow:</span>
            <span class="net-flow-value">--</span>
          </div>

          <div class="whale-signal" id="whale-signal">
            <span class="signal-badge">--</span>
            <span class="signal-text">Loading...</span>
          </div>

          <div class="whale-alerts-count">
            <span class="alerts-icon">üö®</span>
            <span id="whale-alert-count">0</span> whale alerts tracked in last 24h
          </div>
        </div>

        <!-- MVRV Indicator Card -->
        <div class="onchain-card mvrv-card">
          <div class="onchain-card-header">
            <span class="onchain-card-icon">üìä</span>
            <h3>MVRV Ratio</h3>
            {{ partial "tooltip.html" (dict "text" "Market Value to Realized Value. <1 = undervalued, 1-2.4 = fair, 2.4-3.5 = overvalued, >3.5 = extreme.") }}
          </div>

          <div class="mvrv-main">
            <div class="mvrv-value" id="mvrv-value">--</div>
            <div class="mvrv-zone" id="mvrv-zone">Loading...</div>
          </div>

          <div class="mvrv-meter">
            <div class="mvrv-bar">
              <div class="mvrv-fill" id="mvrv-fill" style="width: 0%"></div>
              <div class="mvrv-marker" id="mvrv-marker" style="left: 0%"></div>
            </div>
            <div class="mvrv-zones">
              <span class="zone-label under">Undervalued</span>
              <span class="zone-label fair">Fair</span>
              <span class="zone-label over">Overvalued</span>
              <span class="zone-label extreme">Extreme</span>
            </div>
          </div>

          <div class="mvrv-signal" id="mvrv-signal">
            <p>Loading market valuation signal...</p>
          </div>

          <div class="mvrv-caps">
            <div class="cap-item">
              <span class="cap-label">Market Cap</span>
              <span class="cap-value" id="market-cap">$--</span>
            </div>
            <div class="cap-item">
              <span class="cap-label">Realized Cap</span>
              <span class="cap-value" id="realized-cap">$--</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Advanced On-Chain Metrics (Phase 1 Sprint 1) -->
    <section class="onchain-advanced-section" id="onchain-advanced-metrics">
      <h2>Advanced On-Chain Metrics</h2>
      <p class="section-desc">Professional-grade valuation indicators used by CryptoQuant and Glassnode analysts.</p>

      <div class="advanced-metrics-grid">
        <!-- NVT Ratio Card -->
        <div class="advanced-metric-card nvt-card">
          <div class="metric-card-header">
            <span class="metric-icon">üì°</span>
            <h3>NVT Ratio</h3>
            {{ partial "tooltip.html" (dict "text" "Network Value to Transactions. Compares market cap to transaction volume. Low NVT (<25) = undervalued, High NVT (>65) = overvalued.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="nvt-value">--</span>
            <span class="metric-badge" id="nvt-signal">--</span>
          </div>
          <div class="metric-gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="nvt-gauge-fill" style="width: 0%"></div>
            </div>
            <div class="gauge-labels">
              <span>Undervalued</span>
              <span>Fair</span>
              <span>Overvalued</span>
            </div>
          </div>
          <p class="metric-description" id="nvt-description">Loading...</p>
        </div>

        <!-- Puell Multiple Card -->
        <div class="advanced-metric-card puell-card">
          <div class="metric-card-header">
            <span class="metric-icon">‚õèÔ∏è</span>
            <h3>Puell Multiple</h3>
            {{ partial "tooltip.html" (dict "text" "Daily miner revenue vs 365-day average. <0.5 = buy zone (miner stress), >1.2 = sell zone (high distribution).") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="puell-value">--</span>
            <span class="metric-badge" id="puell-zone">--</span>
          </div>
          <div class="metric-gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="puell-gauge-fill" style="width: 0%"></div>
            </div>
            <div class="gauge-labels">
              <span>Buy Zone</span>
              <span>Neutral</span>
              <span>Sell Zone</span>
            </div>
          </div>
          <p class="metric-description" id="puell-description">Loading...</p>
        </div>

        <!-- Stock-to-Flow Card -->
        <div class="advanced-metric-card s2f-card">
          <div class="metric-card-header">
            <span class="metric-icon">üìä</span>
            <h3>Stock-to-Flow</h3>
            {{ partial "tooltip.html" (dict "text" "Scarcity model comparing existing supply to annual production. Higher S2F = more scarce. Model price based on PlanB's original formula.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="s2f-ratio">--</span>
            <span class="metric-badge" id="s2f-signal">--</span>
          </div>
          <div class="s2f-details">
            <div class="s2f-row">
              <span class="s2f-label">Model Price:</span>
              <span class="s2f-value" id="s2f-model-price">$--</span>
            </div>
            <div class="s2f-row">
              <span class="s2f-label">Deflection:</span>
              <span class="s2f-value" id="s2f-deflection">--%</span>
            </div>
          </div>
          <p class="metric-note">S2F model accuracy varies with market cycles</p>
        </div>

        <!-- Stablecoin Supply Ratio Card -->
        <div class="advanced-metric-card ssr-card">
          <div class="metric-card-header">
            <span class="metric-icon">üíµ</span>
            <h3>Stablecoin Supply Ratio</h3>
            {{ partial "tooltip.html" (dict "text" "BTC market cap divided by total stablecoin market cap. Lower SSR = more buying power waiting on sidelines.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="ssr-value">--</span>
            <span class="metric-badge" id="ssr-trend">--</span>
          </div>
          <div class="metric-gauge">
            <div class="gauge-track inverted">
              <div class="gauge-fill" id="ssr-gauge-fill" style="width: 0%"></div>
            </div>
            <div class="gauge-labels">
              <span>High Buying Power</span>
              <span>Neutral</span>
              <span>Low</span>
            </div>
          </div>
          <p class="metric-description" id="ssr-description">Loading...</p>
        </div>

        <!-- Reserve Risk Card -->
        <div class="advanced-metric-card reserve-risk-card">
          <div class="metric-card-header">
            <span class="metric-icon">‚öñÔ∏è</span>
            <h3>Reserve Risk</h3>
            {{ partial "tooltip.html" (dict "text" "Measures risk/reward of investing. Low values = opportunity zone. High values = risk zone. Based on HODL behavior.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="reserve-risk-value">--</span>
            <span class="metric-badge" id="reserve-risk-zone">--</span>
          </div>
          <p class="metric-description" id="reserve-risk-description">Loading...</p>
        </div>

        <!-- NUPL Card -->
        <div class="advanced-metric-card nupl-card">
          <div class="metric-card-header">
            <span class="metric-icon">üìà</span>
            <h3>NUPL</h3>
            {{ partial "tooltip.html" (dict "text" "Net Unrealized Profit/Loss. Shows what % of market cap is unrealized profit. Zones: Capitulation (<0), Hope (0-25%), Optimism (25-50%), Belief (50-75%), Euphoria (>75%).") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="nupl-value">--</span>
            <span class="metric-badge" id="nupl-zone">--</span>
          </div>
          <div class="nupl-meter">
            <div class="nupl-bar">
              <div class="nupl-zone capitulation"></div>
              <div class="nupl-zone hope"></div>
              <div class="nupl-zone optimism"></div>
              <div class="nupl-zone belief"></div>
              <div class="nupl-zone euphoria"></div>
              <div class="nupl-marker" id="nupl-marker" style="left: 50%"></div>
            </div>
            <div class="nupl-labels">
              <span>Capitulation</span>
              <span>Hope</span>
              <span>Optimism</span>
              <span>Belief</span>
              <span>Euphoria</span>
            </div>
          </div>
          <p class="metric-description" id="nupl-description">Loading...</p>
        </div>
      </div>

      <div class="metrics-data-note">
        <strong>Data Sources:</strong> CoinGecko (prices, market caps), Blockchain.info (transaction volume, miner revenue). Updated every 4 hours.
      </div>
    </section>

    <!-- Price Valuation Models Section (Phase 6) -->
    <section class="price-models-section" id="price-models-section">
      <h2>Bitcoin Valuation Models</h2>
      <p class="section-desc">Comprehensive price models competing with CryptoQuant and Glassnode. Track S2F, Thermocap, NUPL, and more.</p>

      <!-- Overall Valuation Score -->
      <div class="overall-valuation-card">
        <div class="valuation-header">
          <h3>Overall Valuation Score</h3>
          <span class="last-updated" id="pm-last-updated">Loading...</span>
        </div>

        <div class="valuation-main">
          <div class="valuation-score">
            <div class="valuation-score-value" id="pm-overall-score">--</div>
            <div class="valuation-score-scale">
              <span>-100</span>
              <span>0</span>
              <span>+100</span>
            </div>
            <div class="valuation-gauge-container">
              <div class="valuation-gauge">
                <div class="gauge-fill" id="pm-overall-gauge" style="width: 50%"></div>
              </div>
            </div>
          </div>

          <div class="valuation-rating-box">
            <div class="rating-badge" id="pm-overall-rating">Loading...</div>
            <div class="valuation-stats">
              <div class="val-stat">
                <span class="val-label">Confidence</span>
                <span class="val-value" id="pm-overall-confidence">--%</span>
              </div>
              <div class="val-stat">
                <span class="val-label">Model Agreement</span>
                <span class="val-value" id="pm-model-agreement">--%</span>
              </div>
            </div>
          </div>
        </div>

        <p class="valuation-summary" id="pm-overall-summary">Loading valuation analysis...</p>

        <div class="model-agreement-section">
          <div class="agreement-column">
            <h4>Bullish Models (Undervalued)</h4>
            <div class="model-list" id="pm-bullish-models">
              <span class="model-chip">Loading...</span>
            </div>
          </div>
          <div class="agreement-column">
            <h4>Bearish Models (Overvalued)</h4>
            <div class="model-list" id="pm-bearish-models">
              <span class="model-chip">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Individual Model Cards Grid -->
      <div class="price-models-grid">
        <!-- Stock-to-Flow Model -->
        <div class="price-model-card s2f-card">
          <div class="model-card-header">
            <span class="model-icon">üìä</span>
            <h3>Stock-to-Flow Model</h3>
            {{ partial "tooltip.html" (dict "text" "Scarcity model based on supply dynamics. Compares existing stock to annual flow. Higher S2F = more scarce = theoretically higher value.") }}
          </div>
          <div class="model-main-stat">
            <span class="model-label">S2F Ratio</span>
            <span class="model-value" id="pm-s2f-ratio">--</span>
          </div>
          <div class="model-prices">
            <div class="price-row">
              <span>Model Price:</span>
              <span class="price-value" id="pm-s2f-model-price">$--</span>
            </div>
            <div class="price-row">
              <span>Actual Price:</span>
              <span class="price-value" id="pm-s2f-actual-price">$--</span>
            </div>
            <div class="price-row highlight">
              <span>Deflection:</span>
              <span class="price-value" id="pm-s2f-deflection">--%</span>
            </div>
          </div>
          <div class="model-deflection-vis">
            <div class="deflection-track">
              <div class="deflection-marker" id="pm-s2f-deflection-bar"></div>
            </div>
            <div class="deflection-labels">
              <span>Undervalued</span>
              <span>Fair</span>
              <span>Overvalued</span>
            </div>
          </div>
          <div class="model-signal-badge" id="pm-s2f-signal">Loading...</div>
          <p class="model-description" id="pm-s2f-description">Loading...</p>
          <div class="model-meta">
            <span>Next Halving: <strong id="pm-s2f-next-halving">--</strong></span>
            <span>(<span id="pm-s2f-days-until">--</span>)</span>
          </div>
        </div>

        <!-- NUPL Card -->
        <div class="price-model-card nupl-card">
          <div class="model-card-header">
            <span class="model-icon">üìà</span>
            <h3>NUPL</h3>
            {{ partial "tooltip.html" (dict "text" "Net Unrealized Profit/Loss. Shows what % of market cap is unrealized profit. Zones: Capitulation (<0), Hope (0-25%), Optimism (25-50%), Belief (50-75%), Euphoria (>75%).") }}
          </div>
          <div class="model-main-stat">
            <span class="model-label">NUPL Value</span>
            <span class="model-value" id="pm-nupl-value">--</span>
          </div>
          <div class="nupl-zone-badge" id="pm-nupl-zone">Loading...</div>
          <div class="nupl-meter-vis">
            <div class="nupl-meter-track">
              <div class="nupl-zone-segment capitulation"></div>
              <div class="nupl-zone-segment hope"></div>
              <div class="nupl-zone-segment optimism"></div>
              <div class="nupl-zone-segment belief"></div>
              <div class="nupl-zone-segment euphoria"></div>
              <div class="nupl-meter-marker" id="pm-nupl-marker"></div>
            </div>
            <div class="nupl-zone-labels">
              <span>Cap</span>
              <span>Hope</span>
              <span>Opt</span>
              <span>Belief</span>
              <span>Euph</span>
            </div>
          </div>
          <p class="model-description" id="pm-nupl-description">Loading...</p>
        </div>

        <!-- Thermocap Multiple Card -->
        <div class="price-model-card thermocap-card">
          <div class="model-card-header">
            <span class="model-icon">üî•</span>
            <h3>Thermocap Multiple</h3>
            {{ partial "tooltip.html" (dict "text" "Market cap divided by cumulative miner revenue. <10x = undervalued, >50x = extreme overvaluation.") }}
          </div>
          <div class="model-main-stat">
            <span class="model-label">Multiple</span>
            <span class="model-value" id="pm-thermocap-multiple">--</span>
          </div>
          <div class="model-bar-container">
            <div class="model-bar-track">
              <div class="model-bar-fill" id="pm-thermocap-bar" style="width: 0%"></div>
            </div>
            <div class="model-bar-labels">
              <span>Value</span>
              <span>Fair</span>
              <span>Hot</span>
              <span>Extreme</span>
            </div>
          </div>
          <div class="model-signal-badge" id="pm-thermocap-signal">Loading...</div>
          <p class="model-description" id="pm-thermocap-description">Loading...</p>
        </div>

        <!-- Puell Multiple Card -->
        <div class="price-model-card puell-card">
          <div class="model-card-header">
            <span class="model-icon">‚õèÔ∏è</span>
            <h3>Puell Multiple</h3>
            {{ partial "tooltip.html" (dict "text" "Daily miner revenue vs 365-day average. <0.5 = buy zone (miner stress), >4 = sell zone (extreme profitability).") }}
          </div>
          <div class="model-main-stat">
            <span class="model-label">Puell Value</span>
            <span class="model-value" id="pm-puell-value">--</span>
          </div>
          <div class="model-gauge-vis">
            <div class="gauge-track">
              <div class="gauge-fill" id="pm-puell-gauge" style="width: 0%"></div>
            </div>
            <div class="gauge-labels">
              <span>Buy</span>
              <span>Neutral</span>
              <span>Sell</span>
            </div>
          </div>
          <div class="model-signal-badge" id="pm-puell-signal">Loading...</div>
          <p class="model-description" id="pm-puell-description">Loading...</p>
        </div>

        <!-- MVRV Z-Score Card -->
        <div class="price-model-card mvrv-z-card">
          <div class="model-card-header">
            <span class="model-icon">üìâ</span>
            <h3>MVRV Z-Score</h3>
            {{ partial "tooltip.html" (dict "text" "Deviation of MVRV from historical mean. Z > 7 = cycle top, Z < 0 = cycle bottom.") }}
          </div>
          <div class="model-main-stat">
            <span class="model-label">Z-Score</span>
            <span class="model-value" id="pm-mvrv-z-score">--</span>
          </div>
          <div class="model-gauge-vis">
            <div class="gauge-track">
              <div class="gauge-fill" id="pm-mvrv-z-gauge" style="width: 0%"></div>
            </div>
            <div class="gauge-labels">
              <span>Bottom</span>
              <span>Fair</span>
              <span>Top</span>
            </div>
          </div>
          <div class="model-signal-badge" id="pm-mvrv-z-signal">Loading...</div>
          <p class="model-description" id="pm-mvrv-z-description">Loading...</p>
        </div>

        <!-- RHODL Ratio Card -->
        <div class="price-model-card rhodl-card">
          <div class="model-card-header">
            <span class="model-icon">üíé</span>
            <h3>RHODL Ratio</h3>
            {{ partial "tooltip.html" (dict "text" "Long-term vs short-term holder balance. High = accumulation, Low = distribution/speculation.") }}
          </div>
          <div class="model-main-stat">
            <span class="model-label">Ratio</span>
            <span class="model-value" id="pm-rhodl-ratio">--</span>
          </div>
          <div class="model-bar-container">
            <div class="model-bar-track">
              <div class="model-bar-fill" id="pm-rhodl-bar" style="width: 0%"></div>
            </div>
            <div class="model-bar-labels">
              <span>Distribution</span>
              <span>Neutral</span>
              <span>Accumulation</span>
            </div>
          </div>
          <div class="model-signal-badge" id="pm-rhodl-signal">Loading...</div>
          <p class="model-description" id="pm-rhodl-description">Loading...</p>
        </div>

        <!-- Delta Cap Card -->
        <div class="price-model-card delta-cap-card">
          <div class="model-card-header">
            <span class="model-icon">üî∫</span>
            <h3>Delta Cap</h3>
            {{ partial "tooltip.html" (dict "text" "Realized Cap vs Average Cap. Delta Price = historical baseline. Price below Delta = extreme undervaluation.") }}
          </div>
          <div class="model-prices">
            <div class="price-row">
              <span>Delta Price:</span>
              <span class="price-value" id="pm-delta-price">$--</span>
            </div>
            <div class="price-row">
              <span>Current Price:</span>
              <span class="price-value" id="pm-delta-current-price">$--</span>
            </div>
            <div class="price-row highlight">
              <span>Ratio:</span>
              <span class="price-value" id="pm-delta-ratio">--%</span>
            </div>
          </div>
          <div class="model-signal-badge" id="pm-delta-signal">Loading...</div>
          <p class="model-description" id="pm-delta-description">Loading...</p>
        </div>

        <!-- MVRV Card (from Realized Cap) -->
        <div class="price-model-card mvrv-card">
          <div class="model-card-header">
            <span class="model-icon">üí∞</span>
            <h3>MVRV Ratio</h3>
            {{ partial "tooltip.html" (dict "text" "Market Value to Realized Value. <1 = undervalued, 1-2.4 = fair, 2.4-3.5 = overvalued, >3.5 = extreme.") }}
          </div>
          <div class="model-main-stat">
            <span class="model-label">MVRV</span>
            <span class="model-value" id="pm-mvrv-ratio">--</span>
          </div>
          <div class="model-signal-badge" id="pm-mvrv-signal">Loading...</div>
          <p class="model-description" id="pm-mvrv-description">Loading...</p>
        </div>
      </div>

      <div class="metrics-data-note">
        <strong>Data Sources:</strong> CoinGecko (price, market cap), Blockchain.info (mining data). Models updated every 4 hours. These are approximations for demonstration - production would use CoinMetrics/Glassnode APIs.
      </div>
    </section>

    <!-- Profitability Metrics Section (Phase 3: SOPR Family) -->
    <section class="profitability-section" id="profitability-metrics">
      <h2>Profitability Analysis</h2>
      <p class="section-desc">SOPR (Spent Output Profit Ratio) family metrics and realized price analysis. Track when holders are realizing profits or losses.</p>

      <div class="profitability-grid">
        <!-- SOPR Card -->
        <div class="profitability-card sopr-card">
          <div class="metric-card-header">
            <span class="metric-icon">üíπ</span>
            <h3>SOPR</h3>
            {{ partial "tooltip.html" (dict "text" "Spent Output Profit Ratio. >1 = profits being realized, <1 = losses being realized, =1 = equilibrium. SOPR crossing 1.0 signals trend reversals.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="sopr-value">--</span>
            <span class="metric-badge" id="sopr-signal">--</span>
            <span class="metric-trend" id="sopr-trend">‚Üí</span>
          </div>
          <p class="metric-description" id="sopr-description">Loading...</p>
        </div>

        <!-- aSOPR Card -->
        <div class="profitability-card asopr-card">
          <div class="metric-card-header">
            <span class="metric-icon">üîÑ</span>
            <h3>aSOPR</h3>
            {{ partial "tooltip.html" (dict "text" "Adjusted SOPR. Filters out very young outputs to reduce noise. More reliable signal for sustained profit/loss realization.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="asopr-value">--</span>
            <span class="metric-badge" id="asopr-signal">--</span>
          </div>
          <p class="metric-description" id="asopr-description">Loading...</p>
        </div>

        <!-- STH-SOPR Card -->
        <div class="profitability-card sth-sopr-card">
          <div class="metric-card-header">
            <span class="metric-icon">üèÉ</span>
            <h3>STH-SOPR</h3>
            {{ partial "tooltip.html" (dict "text" "Short-Term Holder SOPR (<155 days). Tracks profit/loss realization of recent buyers. Capitulation here signals local bottoms.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="sth-sopr-value">--</span>
            <span class="metric-badge" id="sth-sopr-signal">--</span>
          </div>
          <div class="metric-gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="sth-sopr-gauge-fill" style="width: 0%"></div>
            </div>
            <div class="gauge-labels">
              <span>Capitulation</span>
              <span>Breakeven</span>
              <span>Profit-Taking</span>
            </div>
          </div>
          <p class="metric-description" id="sth-sopr-description">Loading...</p>
        </div>

        <!-- LTH-SOPR Card -->
        <div class="profitability-card lth-sopr-card">
          <div class="metric-card-header">
            <span class="metric-icon">üíé</span>
            <h3>LTH-SOPR</h3>
            {{ partial "tooltip.html" (dict "text" "Long-Term Holder SOPR (>155 days). Tracks smart money profit/loss. High values signal cycle tops, low values signal cycle bottoms.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="lth-sopr-value">--</span>
            <span class="metric-badge" id="lth-sopr-signal">--</span>
          </div>
          <div class="metric-gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="lth-sopr-gauge-fill" style="width: 0%"></div>
            </div>
            <div class="gauge-labels">
              <span>Capitulation</span>
              <span>Accumulation</span>
              <span>Distribution</span>
            </div>
          </div>
          <p class="metric-description" id="lth-sopr-description">Loading...</p>
        </div>

        <!-- Realized Price Card -->
        <div class="profitability-card realized-price-card">
          <div class="metric-card-header">
            <span class="metric-icon">üí∞</span>
            <h3>Realized Price</h3>
            {{ partial "tooltip.html" (dict "text" "Average price at which all coins last moved. Critical support/resistance level. Price below realized = market in loss.") }}
          </div>
          <div class="metric-main">
            <span class="metric-value" id="realized-price">--</span>
            <span class="metric-badge" id="realized-price-signal">--</span>
          </div>
          <div class="realized-price-vs">
            <span class="realized-label">vs Current Price:</span>
            <span class="realized-value" id="realized-price-vs-current">--%</span>
          </div>
          <div class="realized-price-scale">
            <div class="scale-bar">
              <div class="scale-marker" id="realized-price-marker" style="left: 50%"></div>
            </div>
            <div class="scale-labels">
              <span>-50%</span>
              <span>0%</span>
              <span>+50%</span>
            </div>
          </div>
          <p class="metric-description" id="realized-price-description">Loading...</p>
        </div>

        <!-- STH/LTH Realized Prices Card -->
        <div class="profitability-card cohort-realized-card">
          <div class="metric-card-header">
            <span class="metric-icon">üìä</span>
            <h3>Cohort Realized Prices</h3>
            {{ partial "tooltip.html" (dict "text" "Average cost basis for short-term vs long-term holders. Shows profitability of different holder groups.") }}
          </div>
          <div class="cohort-prices">
            <div class="cohort-row">
              <span class="cohort-label">üèÉ STH Realized:</span>
              <span class="cohort-value" id="sth-realized-price">--</span>
            </div>
            <div class="cohort-row">
              <span class="cohort-label">üíé LTH Realized:</span>
              <span class="cohort-value" id="lth-realized-price">--</span>
            </div>
          </div>
          <p class="metric-note">STH = <155 days, LTH = >155 days</p>
        </div>
      </div>

      <div class="metrics-data-note profitability-last-updated">
        <strong>Data Sources:</strong> CoinGecko price history. Proxy SOPR calculations based on volume-weighted cost basis. Updated every 4 hours.
      </div>
    </section>

    <!-- Exchange Flows Section (Phase 2: Exchange Intelligence) -->
    <section class="exchange-flows-section" id="exchange-flows-section">
      <!-- Content rendered by JavaScript -->
    </section>

    <!-- Signal Accuracy Tracking (Phase 6) -->
    <section class="accuracy-section">
      <h2>Signal Accuracy Tracking</h2>
      <p class="section-desc">Public verification of our signal accuracy. Updated daily after 24-hour price checks.</p>

      <div class="accuracy-grid">
        <div class="accuracy-card accuracy-main">
          <div class="accuracy-header">
            <span class="accuracy-icon">üéØ</span>
            <h3>Overall Accuracy</h3>
          </div>
          <div class="accuracy-big-value" id="accuracy-all">--%</div>
          <div class="accuracy-subtitle" id="accuracy-total-signals">0 signals tracked</div>
        </div>

        <div class="accuracy-card">
          <div class="accuracy-label">7-Day Accuracy</div>
          <div class="accuracy-value" id="accuracy-7d">--%</div>
        </div>

        <div class="accuracy-card">
          <div class="accuracy-label">30-Day Accuracy</div>
          <div class="accuracy-value" id="accuracy-30d">--%</div>
        </div>

        <div class="accuracy-card">
          <div class="accuracy-label">Current Streak</div>
          <div class="accuracy-value" id="accuracy-streak">--</div>
        </div>

        <div class="accuracy-card">
          <div class="accuracy-label">Best Streak</div>
          <div class="accuracy-value" id="accuracy-best-streak">--</div>
        </div>

        <div class="accuracy-card">
          <div class="accuracy-label">Avg Confidence</div>
          <div class="accuracy-value" id="accuracy-avg-confidence">--%</div>
        </div>
      </div>

      <div class="accuracy-note">
        <strong>How it works:</strong> Each signal is logged with price and direction. After 24 hours, we check if the price moved in the predicted direction. Results are publicly tracked.
      </div>
    </section>

    <!-- Performance Stats -->
    <section class="stats-section">
      <h2>Signal Performance</h2>
      <div class="stats-grid">
        <div class="stat-card win">
          <span class="stat-number" id="win-count">-</span>
          <span class="stat-label">Winning Calls</span>
        </div>
        <div class="stat-card loss">
          <span class="stat-number" id="loss-count">-</span>
          <span class="stat-label">Losing Calls</span>
        </div>
        <div class="stat-card rate">
          <span class="stat-number" id="win-rate">-</span>
          <span class="stat-label">Win Rate</span>
        </div>
        <div class="stat-card streak">
          <span class="stat-number" id="current-streak">-</span>
          <span class="stat-label">Current Streak</span>
        </div>
      </div>

      <!-- Extended Trade Metrics -->
      <h3 class="subsection-title">Advanced Metrics</h3>
      <div class="stats-grid">
        <div class="stat-card r-multiple">
          <span class="stat-number" id="avg-r-multiple">-</span>
          <span class="stat-label">Avg R-Multiple</span>
        </div>
        <div class="stat-card drawdown">
          <span class="stat-number" id="max-drawdown">-</span>
          <span class="stat-label">Max Drawdown</span>
        </div>
        <div class="stat-card bias">
          <span class="stat-number" id="long-bias">-</span>
          <span class="stat-label">Directional Bias</span>
        </div>
      </div>

      <!-- Calendar Heatmap -->
      <div class="calendar-section">
        <h3 class="subsection-title">90-Day Activity</h3>
        <div class="calendar-heatmap" id="calendar-heatmap">
          <!-- Populated by JS -->
        </div>
        <div class="calendar-legend">
          <span class="legend-item"><span class="cal-day win"></span> Win</span>
          <span class="legend-item"><span class="cal-day loss"></span> Loss</span>
          <span class="legend-item"><span class="cal-day pending"></span> Pending</span>
          <span class="legend-item"><span class="cal-day"></span> No Trade</span>
        </div>
      </div>
    </section>

    <!-- Simulated Portfolio Section -->
    <section class="portfolio-section">
      <h2>Simulated Portfolio</h2>
      <p class="section-desc">Track hypothetical returns following our signals with $10,000 starting capital at 1% position sizing</p>

      <div class="portfolio-overview">
        <div class="portfolio-card portfolio-balance">
          <div class="portfolio-card-header">
            <span class="portfolio-icon">üí∞</span>
            <h3>Current Balance</h3>
          </div>
          <div class="portfolio-value" id="portfolio-balance">$10,000.00</div>
          <div class="portfolio-change" id="portfolio-change">
            <span class="change-amount">$0.00</span>
            <span class="change-percent">(0.00%)</span>
          </div>
          <div class="portfolio-start">Started: $10,000.00</div>
        </div>

        <div class="portfolio-card portfolio-stats">
          <div class="portfolio-card-header">
            <span class="portfolio-icon">üìä</span>
            <h3>Performance Stats</h3>
          </div>
          <div class="portfolio-stats-grid">
            <div class="pstat">
              <span class="pstat-value" id="portfolio-total-trades">0</span>
              <span class="pstat-label">Total Trades</span>
            </div>
            <div class="pstat">
              <span class="pstat-value" id="portfolio-winning-trades">0</span>
              <span class="pstat-label">Winning</span>
            </div>
            <div class="pstat">
              <span class="pstat-value" id="portfolio-losing-trades">0</span>
              <span class="pstat-label">Losing</span>
            </div>
            <div class="pstat">
              <span class="pstat-value" id="portfolio-avg-win">$0.00</span>
              <span class="pstat-label">Avg Win</span>
            </div>
            <div class="pstat">
              <span class="pstat-value" id="portfolio-avg-loss">$0.00</span>
              <span class="pstat-label">Avg Loss</span>
            </div>
            <div class="pstat">
              <span class="pstat-value" id="portfolio-best-trade">$0.00</span>
              <span class="pstat-label">Best Trade</span>
            </div>
          </div>
        </div>

        <div class="portfolio-card portfolio-settings">
          <div class="portfolio-card-header">
            <span class="portfolio-icon">‚öôÔ∏è</span>
            <h3>Settings</h3>
          </div>
          <div class="portfolio-setting">
            <span class="setting-label">Starting Capital</span>
            <span class="setting-value">$10,000</span>
          </div>
          <div class="portfolio-setting">
            <span class="setting-label">Position Size</span>
            <span class="setting-value">1% per trade</span>
          </div>
          <div class="portfolio-setting">
            <span class="setting-label">Risk per Trade</span>
            <span class="setting-value" id="portfolio-risk-per-trade">$100.00</span>
          </div>
          <div class="portfolio-setting">
            <span class="setting-label">Leverage</span>
            <span class="setting-value">1x (No leverage)</span>
          </div>
        </div>
      </div>

      <a href="/trading-history/" class="btn-view-history">View Full Trading History</a>
    </section>

    <!-- BART Risk Analysis Section -->
    <section class="bart-analysis-section">
      <h2>BART Pattern Analysis</h2>
      <p class="section-desc">Manipulation pattern detection and pre-warning system</p>

      <div class="bart-analysis-grid">
        <!-- Current Risk Overview -->
        <div class="bart-card bart-current-risk">
          <div class="bart-card-header">
            <span class="bart-card-icon">‚ö°</span>
            <h3>Current BART Risk</h3>
          </div>
          <div class="bart-risk-gauge">
            <div class="bart-gauge-value" id="dash-bart-score">--</div>
            <div class="bart-gauge-label" id="dash-bart-level">Loading...</div>
            <div class="bart-gauge-ring">
              <svg viewBox="0 0 100 100">
                <circle class="bart-gauge-bg" cx="50" cy="50" r="45"/>
                <circle class="bart-gauge-fill" id="dash-bart-gauge" cx="50" cy="50" r="45"/>
              </svg>
            </div>
          </div>
          <div class="bart-status-message" id="dash-bart-status">Analyzing...</div>
        </div>

        <!-- Risk Factors Breakdown -->
        <div class="bart-card bart-factors-detail">
          <div class="bart-card-header">
            <span class="bart-card-icon">üìä</span>
            <h3>Risk Factor Breakdown</h3>
          </div>
          <div class="bart-factors-list" id="dash-bart-factors">
            <!-- Populated by JS -->
          </div>
          <div class="bart-factors-legend">
            <span class="legend-item warning">Warning threshold reached</span>
          </div>
        </div>

        <!-- Risk History Chart -->
        <div class="bart-card bart-history-chart">
          <div class="bart-card-header">
            <span class="bart-card-icon">üìà</span>
            <h3>24h Risk History</h3>
          </div>
          <div class="bart-chart-container">
            <canvas id="bartRiskChart" height="200"></canvas>
          </div>
          <div class="bart-chart-stats">
            <div class="chart-stat">
              <span class="stat-label">Avg Risk</span>
              <span class="stat-value" id="dash-bart-avg">--</span>
            </div>
            <div class="chart-stat">
              <span class="stat-label">Peak Risk</span>
              <span class="stat-value" id="dash-bart-peak">--</span>
            </div>
            <div class="chart-stat">
              <span class="stat-label">Time at High</span>
              <span class="stat-value" id="dash-bart-high-time">--</span>
            </div>
          </div>
        </div>

        <!-- BART Events History -->
        <div class="bart-card bart-events-history">
          <div class="bart-card-header">
            <span class="bart-card-icon">üéØ</span>
            <h3>Detected BART Events</h3>
            <button class="btn-clear-history" id="btn-clear-bart-history" title="Clear history">Clear</button>
          </div>
          <div class="bart-events-list" id="dash-bart-events">
            <div class="bart-event-empty">No BART events detected yet. Events are logged when price moves 2%+ and returns to origin.</div>
          </div>
          <div class="bart-events-stats">
            <div class="event-stat">
              <span class="stat-label">Total Events</span>
              <span class="stat-value" id="dash-bart-total">0</span>
            </div>
            <div class="event-stat">
              <span class="stat-label">Up BARTs</span>
              <span class="stat-value up" id="dash-bart-up">0</span>
            </div>
            <div class="event-stat">
              <span class="stat-label">Down BARTs</span>
              <span class="stat-value down" id="dash-bart-down">0</span>
            </div>
            <div class="event-stat">
              <span class="stat-label">Avg Magnitude</span>
              <span class="stat-value" id="dash-bart-magnitude">--%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- BART Pattern Explainer -->
      <div class="bart-explainer">
        <h4>What is a BART Pattern?</h4>
        <p>A BART pattern (named after Bart Simpson's head shape) is a manipulation pattern where price spikes sharply, consolidates briefly, then reverses back to the starting point. This system monitors 5 risk factors that often precede BARTs:</p>
        <div class="bart-factors-explainer">
          <div class="factor-explain">
            <span class="factor-icon">üïê</span>
            <strong>Market Hours</strong>
            <span>Weekends and off-peak hours have thinner liquidity</span>
          </div>
          <div class="factor-explain">
            <span class="factor-icon">üí∞</span>
            <strong>Funding Rate</strong>
            <span>Extreme funding indicates over-leveraged positions</span>
          </div>
          <div class="factor-explain">
            <span class="factor-icon">üìä</span>
            <strong>Volatility</strong>
            <span>Low volatility often precedes sharp moves</span>
          </div>
          <div class="factor-explain">
            <span class="factor-icon">üìà</span>
            <strong>OI/Volume</strong>
            <span>High open interest vs volume = liquidation risk</span>
          </div>
          <div class="factor-explain">
            <span class="factor-icon">üéØ</span>
            <strong>Price Range</strong>
            <span>Tight consolidation = coiled spring ready to move</span>
          </div>
        </div>
      </div>
    </section>

    <!-- On-Chain & Macro Metrics -->
    <section class="onchain-section">
      <h2>On-Chain & Macro Analysis</h2>
      <p class="section-desc">Network fundamentals and cross-market correlations</p>

      <div class="onchain-grid">
        <!-- Hashrate vs Price Widget -->
        <div class="onchain-card">
          <div class="onchain-header">
            <span class="onchain-icon">‚õèÔ∏è</span>
            <h3>Hashrate vs Price</h3>
          </div>
          <div class="onchain-metrics">
            <div class="metric-row">
              <span class="metric-label">Network Hashrate</span>
              <span class="metric-value" id="dash-hashrate-value">--</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">30d Change</span>
              <span class="metric-value" id="dash-hashrate-change">--</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Hash/Price Ratio</span>
              <span class="metric-value" id="dash-hash-price-ratio">--</span>
            </div>
          </div>
          <div class="onchain-signal" id="dash-hashrate-signal">
            <span class="signal-badge neutral">Loading...</span>
          </div>
          <div class="onchain-chart">
            <canvas id="hashrateChart" height="120"></canvas>
          </div>
          <p class="onchain-note">Rising hashrate with stable price = bullish divergence</p>
        </div>

        <!-- BTC vs S&P500 Correlation Widget -->
        <div class="onchain-card">
          <div class="onchain-header">
            <span class="onchain-icon">üìä</span>
            <h3>BTC vs S&P 500</h3>
          </div>
          <div class="onchain-metrics">
            <div class="metric-row">
              <span class="metric-label">30d Correlation</span>
              <span class="metric-value" id="dash-correlation-value">--</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">BTC 30d Return</span>
              <span class="metric-value" id="dash-btc-return">--</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">S&P 30d Return</span>
              <span class="metric-value" id="dash-sp500-return">--</span>
            </div>
          </div>
          <div class="onchain-signal" id="dash-correlation-signal">
            <span class="signal-badge neutral">Loading...</span>
          </div>
          <div class="onchain-chart">
            <canvas id="correlationChart" height="120"></canvas>
          </div>
          <p class="onchain-note">Low correlation = BTC acting as uncorrelated asset</p>
        </div>
      </div>
    </section>

    <!-- Cohort Analysis Section (Phase 4) -->
    <section class="cohort-metrics-section">
      <h2>üë• Holder Cohort Analysis</h2>
      <p class="section-desc">Long-term vs short-term holder behavior and whale tier distribution. Data updated every 6 hours.</p>

      <div id="cohort-metrics-container">
        <!-- Content loaded by cohort-metrics.js -->
        <div class="cohort-metrics-loading">
          <p>Loading cohort analysis...</p>
        </div>
      </div>
    </section>

    <!-- Liquidation Watchlist -->
    <section class="liquidation-section">
      <h2>Liquidation Watchlist</h2>
      <p class="section-desc">Key price levels where large liquidations may occur</p>

      <div class="liquidation-grid">
        <div class="liquidation-card long">
          <div class="liq-header">
            <span class="liq-type">üìà LONG LIQUIDATIONS</span>
            <span class="liq-risk high">High Risk Zone</span>
          </div>
          <div class="liq-levels" id="long-liquidations">
            <div class="liq-level">
              <span class="price">Loading...</span>
              <span class="amount"></span>
            </div>
          </div>
        </div>

        <div class="liquidation-card short">
          <div class="liq-header">
            <span class="liq-type">üìâ SHORT LIQUIDATIONS</span>
            <span class="liq-risk high">High Risk Zone</span>
          </div>
          <div class="liq-levels" id="short-liquidations">
            <div class="liq-level">
              <span class="price">Loading...</span>
              <span class="amount"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="current-price-box" role="status" aria-live="polite">
        <span class="label">Current BTC Price</span>
        <span class="price" id="current-btc-price">Loading...</span>
      </div>
    </section>

    <!-- Signal Aggregator (Phase 7 - Prominent Position) -->
    <section class="signal-aggregator-section">
      <h2>üéØ Overall Market Signal</h2>
      <p class="section-desc">AI-powered signal aggregation combining all data sources with weighted confidence scoring</p>

      <div class="signal-aggregator-grid">
        <!-- Overall Signal Display -->
        <div class="signal-overall-card">
          <div class="signal-overall-header">
            <h3>Current Signal</h3>
          </div>
          <div class="signal-overall-value" id="overall-signal-value">LOADING</div>
          <div class="signal-overall-label" id="overall-signal-label">Analyzing market conditions...</div>

          <div class="confidence-section">
            <h4>Signal Confidence</h4>
            <div class="confidence-gauge">
              <div class="confidence-gauge-track">
                <div class="confidence-gauge-fill" id="confidence-gauge-fill"></div>
              </div>
            </div>
            <div class="confidence-value" id="confidence-value">--%</div>
            <div class="confidence-label" id="confidence-label">Calculating...</div>
          </div>
        </div>

        <!-- Category Breakdown -->
        <div class="signal-breakdown-card">
          <div class="signal-breakdown-header">
            <h3>Category Breakdown</h3>
          </div>
          <div id="signal-breakdown-bars">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Bullish Factors -->
        <div class="signal-factors-card factors-bullish">
          <div class="factors-header">
            <span class="factors-icon">üìà</span>
            <h3>Top 5 Bullish Factors</h3>
          </div>
          <div class="factors-list" id="bullish-factors-list">
            <p class="factors-loading">Loading factors...</p>
          </div>
        </div>

        <!-- Bearish Factors -->
        <div class="signal-factors-card factors-bearish">
          <div class="factors-header">
            <span class="factors-icon">üìâ</span>
            <h3>Top 5 Bearish Factors</h3>
          </div>
          <div class="factors-list" id="bearish-factors-list">
            <p class="factors-loading">Loading factors...</p>
          </div>
        </div>
      </div>

      <div class="signal-note">
        <strong>Methodology:</strong> Signals are weighted by category (On-Chain: 30%, Technical: 25%, Derivatives: 20%, Price Models: 15%, Sentiment: 10%). Updated every 15 minutes.
      </div>
    </section>

    <!-- Alert System (Phase 7) -->
    <section class="alerts-section">
      <h2>üö® Alert System</h2>
      <p class="section-desc">Real-time monitoring of critical market conditions. Get notified when key thresholds are breached.</p>

      <div class="alerts-grid">
        <!-- Alert Stats -->
        <div class="alerts-stats-row">
          <div class="alert-stat-card">
            <span class="alert-stat-icon">üìä</span>
            <span class="alert-stat-value" id="alert-total">0</span>
            <span class="alert-stat-label">Total Alerts (24h)</span>
          </div>
          <div class="alert-stat-card critical">
            <span class="alert-stat-icon">üî¥</span>
            <span class="alert-stat-value" id="alert-critical">0</span>
            <span class="alert-stat-label">Critical</span>
          </div>
          <div class="alert-stat-card warning">
            <span class="alert-stat-icon">‚ö†Ô∏è</span>
            <span class="alert-stat-value" id="alert-warning">0</span>
            <span class="alert-stat-label">Warning</span>
          </div>
          <div class="alert-stat-card info">
            <span class="alert-stat-icon">‚ÑπÔ∏è</span>
            <span class="alert-stat-value" id="alert-info">0</span>
            <span class="alert-stat-label">Info</span>
          </div>
        </div>

        <!-- Active Alerts -->
        <div class="alerts-active-card">
          <div class="alerts-card-header">
            <h3>Active Alerts</h3>
            <div class="alerts-header-actions">
              <button class="btn-alert-refresh" id="btn-refresh-alerts" title="Refresh alerts">üîÑ</button>
              <button class="btn-alert-clear" id="btn-clear-acknowledged" title="Clear acknowledged">Clear</button>
            </div>
          </div>
          <div class="alerts-filters">
            <button class="alert-filter-btn active" data-severity="all">All</button>
            <button class="alert-filter-btn" data-severity="critical">Critical</button>
            <button class="alert-filter-btn" data-severity="warning">Warning</button>
            <button class="alert-filter-btn" data-severity="info">Info</button>
          </div>
          <div class="alerts-list" id="active-alerts-list">
            <div class="alerts-loading">Loading alerts...</div>
          </div>
          <div class="alerts-last-checked" id="alerts-last-checked">Checking...</div>
        </div>

        <!-- Alert History -->
        <div class="alerts-history-card">
          <div class="alerts-card-header">
            <h3>Alert History (Last 24h)</h3>
          </div>
          <div class="alert-history-list" id="alert-history-list">
            <div class="alerts-loading">Loading history...</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Market Report (Phase 7) -->
    <section class="market-report-section">
      <h2>üìä Daily Market Report</h2>
      <p class="section-desc">Comprehensive daily analysis with market grade, key highlights, and trading recommendations</p>

      <div class="market-report-grid" id="market-report-container">
        <!-- Market Grade Card -->
        <div class="market-grade-card">
          <div class="market-grade-header">
            <h3>Today's Market Grade</h3>
            <span class="market-report-date" id="market-report-date">Loading...</span>
          </div>
          <div class="market-grade-display">
            <div class="market-grade-value" id="market-grade-value">--</div>
            <div class="market-grade-label" id="market-grade-label">Loading...</div>
          </div>
          <div class="market-grade-score">
            <span class="grade-score-label">Score:</span>
            <span class="grade-score-value" id="market-grade-score">--/100</span>
          </div>
          <div class="market-signal-badge" id="market-signal-badge">--</div>
          <div class="market-confidence">
            <span>Confidence:</span>
            <span id="market-confidence">--%</span>
          </div>
        </div>

        <!-- Summary Card -->
        <div class="market-summary-card">
          <div class="market-card-header">
            <h3>Market Summary</h3>
          </div>
          <p class="market-summary-text" id="market-summary-text">Loading market summary...</p>
        </div>

        <!-- Highlights -->
        <div class="market-highlights-card">
          <div class="market-card-header">
            <h3>Key Highlights</h3>
          </div>
          <div id="market-highlights">
            <p class="loading-text">Loading highlights...</p>
          </div>
        </div>

        <!-- Warnings -->
        <div class="market-warnings-card">
          <div class="market-card-header">
            <h3>‚ö†Ô∏è Active Warnings</h3>
          </div>
          <div id="market-warnings">
            <p class="loading-text">Loading warnings...</p>
          </div>
        </div>

        <!-- Signal Breakdown -->
        <div class="market-breakdown-card">
          <div class="market-card-header">
            <h3>Signal Breakdown by Category</h3>
          </div>
          <div id="signal-breakdown">
            <p class="loading-text">Loading breakdown...</p>
          </div>
        </div>

        <!-- Recommendation -->
        <div class="market-recommendation-card">
          <div class="market-card-header">
            <h3>üí° Trading Recommendation</h3>
          </div>
          <div id="market-recommendation">
            <p class="loading-text">Loading recommendation...</p>
          </div>
        </div>

        <!-- Historical Grade Chart -->
        <div class="market-history-card">
          <div class="market-card-header">
            <h3>30-Day Grade History</h3>
          </div>
          <div class="grade-chart-container">
            <canvas id="grade-history-chart" height="200"></canvas>
          </div>
        </div>
      </div>

      <div class="market-report-actions">
        <button class="btn-export-report" id="btn-export-report-pdf">
          <i class="fas fa-file-pdf"></i> Export to PDF
        </button>
      </div>
    </section>

    <!-- Paper Trading Journal -->
    <section class="paper-trading-section" id="paper-trading-section">
      <h2>üìù Paper Trading Journal</h2>
      <p class="section-desc">Practice your strategy with simulated trades before risking real capital</p>

      <div class="paper-trading-container">
        <!-- Stats Overview -->
        <div class="paper-stats-grid">
          <div class="paper-stat-card">
            <span class="paper-stat-icon">üí∞</span>
            <div class="paper-stat-info">
              <span class="paper-stat-value" id="paper-capital">$100.00</span>
              <span class="paper-stat-label">Current Capital</span>
            </div>
          </div>
          <div class="paper-stat-card">
            <span class="paper-stat-icon">üìä</span>
            <div class="paper-stat-info">
              <span class="paper-stat-value" id="paper-pnl">$0.00</span>
              <span class="paper-stat-label">Total P&L</span>
            </div>
          </div>
          <div class="paper-stat-card">
            <span class="paper-stat-icon">üéØ</span>
            <div class="paper-stat-info">
              <span class="paper-stat-value" id="paper-winrate">--%</span>
              <span class="paper-stat-label">Win Rate</span>
            </div>
          </div>
          <div class="paper-stat-card">
            <span class="paper-stat-icon">üìà</span>
            <div class="paper-stat-info">
              <span class="paper-stat-value" id="paper-trades">0</span>
              <span class="paper-stat-label">Total Trades</span>
            </div>
          </div>
        </div>

        <!-- New Trade Form -->
        <div class="paper-trade-form">
          <h3>Log New Trade</h3>
          <form id="paper-trade-form">
            <div class="form-row">
              <div class="form-group">
                <label for="paper-direction">Direction</label>
                <select id="paper-direction" required>
                  <option value="long">üü¢ Long</option>
                  <option value="short">üî¥ Short</option>
                </select>
              </div>
              <div class="form-group">
                <label for="paper-entry">Entry Price</label>
                <input type="number" id="paper-entry" step="0.01" placeholder="e.g. 42000" required>
              </div>
              <div class="form-group">
                <label for="paper-size">Position Size ($)</label>
                <input type="number" id="paper-size" step="0.01" placeholder="e.g. 10" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="paper-sl">Stop Loss</label>
                <input type="number" id="paper-sl" step="0.01" placeholder="e.g. 41500" required>
              </div>
              <div class="form-group">
                <label for="paper-tp">Take Profit</label>
                <input type="number" id="paper-tp" step="0.01" placeholder="e.g. 43000">
              </div>
              <div class="form-group">
                <label for="paper-notes">Notes</label>
                <input type="text" id="paper-notes" placeholder="Trade reasoning...">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-paper-trade">üìù Log Trade</button>
              <button type="button" class="btn-paper-clear" id="btn-paper-clear">üóëÔ∏è Clear All</button>
            </div>
          </form>
        </div>

        <!-- Trade History -->
        <div class="paper-trades-history">
          <h3>Trade History</h3>
          <div class="paper-trades-list" id="paper-trades-list">
            <div class="paper-trades-empty">
              <span class="empty-icon">üìã</span>
              <p>No trades yet. Start logging your paper trades above!</p>
            </div>
          </div>
        </div>

        <!-- Risk Management Rules -->
        <div class="paper-risk-rules">
          <h4>‚ö†Ô∏è Risk Management Rules</h4>
          <ul class="risk-rules-list">
            <li><span class="rule-status" id="rule-sl">‚úì</span> Stop loss required on every trade</li>
            <li><span class="rule-status" id="rule-risk">‚úì</span> Max 2% risk per trade</li>
            <li><span class="rule-status" id="rule-daily">‚úì</span> Max 5% daily loss</li>
            <li><span class="rule-status" id="rule-streak">‚úì</span> Stop after 3 consecutive losses</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Watchlist (Phase 7) -->
    <section class="watchlist-section">
      <h2>‚≠ê My Watchlist</h2>
      <p class="section-desc">Save and monitor your favorite metrics for quick access</p>

      <div class="watchlist-container">
        <div class="watchlist-header">
          <button class="btn-clear-watchlist" id="btn-clear-watchlist">Clear All</button>
        </div>
        <div class="watchlist-items" id="watchlist-items">
          <div class="watchlist-empty">
            <span class="watchlist-empty-icon">üìã</span>
            <p>Your watchlist is empty</p>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>

{{ end }}
