
{{/* Load Three.js if page needs 3D */}}
{{ if .Params.threejs }}
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
{{ end }}

{{/* Load TradingView Lightweight Charts if needed */}}
{{ if .Params.lightweightCharts }}
  <script defer src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
{{ end }}

{{/* Load html2canvas for screenshots */}}
{{ if .Params.html2canvas }}
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
{{ end }}

{{/* Load Chart.js if page needs charts */}}
{{ if .Params.charts }}
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  {{ if .Params.chartAnnotations }}
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  {{ end }}
{{ end }}

{{/* Load QRCode.js if page needs QR codes (from Params or Scratch) */}}
{{ if or .Params.qrcode (.Scratch.Get "qrcode") }}
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
{{ end }}

{{/* Load security utilities (XSS prevention) */}}
<script defer src="{{ "src/js/security-utils.js" | relURL }}"></script>

{{/* Load shared utilities first (required by other scripts) */}}
{{ if .Params.js }}
  <script defer src="{{ "src/js/shared.js" | relURL }}"></script>
  {{/* Load new indicator and analytics modules */}}
  <script defer src="{{ "src/js/indicators.js" | relURL }}"></script>

  {{/* On-chain metrics for dashboard, backtester, and chart pages */}}
  {{ if or (eq .Type "dashboard") (eq .Type "backtester-pro") (eq .Type "smart-chart-pro") (eq .Type "on-chain") }}
  <script defer src="{{ "src/js/onchain-metrics.js" | relURL }}"></script>
  {{ end }}

  {{/* Live price feed for paper trading and trade coach */}}
  {{ if or (eq .Type "paper-trading") (eq .Type "trade-coach") }}
  <script defer src="{{ "src/js/live-price-feed.js" | relURL }}"></script>
  {{ end }}

  {{/* Drawing tools for chart pages */}}
  {{ if or (eq .Type "smart-chart-pro") (eq .Type "smart-chart") }}
  <script defer src="{{ "src/js/drawing-tools.js" | relURL }}"></script>
  {{ end }}

  {{/* Multi-pane charts and liquidation heatmap */}}
  {{ if or (eq .Type "smart-chart-pro") (eq .Type "backtester-pro") (eq .Type "dashboard") }}
  <script defer src="{{ "src/js/multi-pane-chart.js" | relURL }}"></script>
  <script defer src="{{ "src/js/liquidation-heatmap.js" | relURL }}"></script>
  {{ end }}

  {{/* Correlation matrix for analytics pages */}}
  {{ if or (eq .Type "dashboard") (eq .Type "on-chain") }}
  <script defer src="{{ "src/js/correlation-matrix.js" | relURL }}"></script>
  {{ end }}

  {{/* Paper trading for dashboard */}}
  {{ if eq .Type "dashboard" }}
  <script defer src="{{ "src/js/paper-trading.js" | relURL }}"></script>
  <script defer src="{{ "src/js/price-models.js" | relURL }}"></script>
  <script defer src="{{ "src/js/signal-aggregator.js" | relURL }}"></script>
  <script defer src="{{ "src/js/market-report.js" | relURL }}"></script>
  {{ end }}

  {{/* Chart export utility for chart pages */}}
  {{ if or (eq .Type "smart-chart-pro") (eq .Type "smart-chart") (eq .Type "backtester-pro") }}
  <script defer src="{{ "src/js/chart-export.js" | relURL }}"></script>
  {{ end }}
{{ end }}

{{/* Load page-specific JS from frontmatter */}}
{{ range .Params.js }}
  <script defer src="{{ "src/js/" | relURL }}{{ . }}"></script>
{{ end }}

{{/* Load page-specific JS from Scratch (for computed/conditional scripts) */}}
{{ range .Scratch.Get "postJs" }}
  <script defer src="{{ "src/js/" | relURL }}{{ . }}"></script>
{{ end }}


<script defer src="{{ "src/js/bootstrap/popper.min.js" | relURL }}"></script>
<script defer src="{{ "src/js/bootstrap/bootstrap.min.js" | relURL }}"></script>

<!-- Page View Tracking (anonymous, count only) -->
<script>
(function() {
  // Only track once per page load, skip bots
  if (navigator.webdriver) return;

  var page = window.location.pathname;

  fetch('/.netlify/functions/track-view', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ page: page })
  }).catch(function() {}); // Silent fail
})();
</script>