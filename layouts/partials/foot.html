
{{/* Load Three.js if page needs 3D */}}
{{ if .Params.threejs }}
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
{{ end }}

{{/* Load TradingView Lightweight Charts if needed */}}
{{ if .Params.lightweightCharts }}
  <script defer src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
{{ end }}

{{/* Load html2canvas for screenshots */}}
{{ if .Params.html2canvas }}
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
{{ end }}

{{/* Load Chart.js if page needs charts */}}
{{ if .Params.charts }}
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  {{ if .Params.chartAnnotations }}
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  {{ end }}
{{ end }}

{{/* Load QRCode.js if page needs QR codes (from Params or Scratch) */}}
{{ if or .Params.qrcode (.Scratch.Get "qrcode") }}
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
{{ end }}

{{/* Load security utilities (XSS prevention) */}}
<script defer src="{{ "src/js/security-utils.js" | relURL }}"></script>

{{/* Load shared utilities first (required by other scripts) */}}
{{ if .Params.js }}
  <script defer src="{{ "src/js/shared.js" | relURL }}"></script>
{{ end }}

{{/* Load page-specific JS from frontmatter */}}
{{ range .Params.js }}
  <script defer src="{{ "src/js/" | relURL }}{{ . }}"></script>
{{ end }}

{{/* Load page-specific JS from Scratch (for computed/conditional scripts) */}}
{{ range .Scratch.Get "postJs" }}
  <script defer src="{{ "src/js/" | relURL }}{{ . }}"></script>
{{ end }}


<script defer src="{{ "src/js/bootstrap/popper.min.js" | relURL }}"></script>
<script defer src="{{ "src/js/bootstrap/bootstrap.min.js" | relURL }}"></script>

<!-- Page View Tracking (anonymous, count only) -->
<script>
(function() {
  // Only track once per page load, skip bots
  if (navigator.webdriver) return;

  var page = window.location.pathname;

  fetch('/.netlify/functions/track-view', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ page: page })
  }).catch(function() {}); // Silent fail
})();
</script>