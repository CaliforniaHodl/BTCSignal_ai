{{ define "main" }}
<article class="container article-page">
  <header class="article-header">
    <a href="/learn/" class="back-link">‚Üê Back to Learn</a>

    {{/* Display icon if available */}}
    {{ if .Params.icon }}
    <div class="article-icon-large">{{ .Params.icon }}</div>
    {{ end }}

    <h1>{{ .Title }}</h1>
    <p class="article-description">{{ .Description }}</p>
    <div class="article-meta">
      <span class="date">{{ .Date.Format "January 2, 2006" }}</span>
      <span class="read-time">{{ .ReadingTime }} min read</span>
      {{ if .Params.difficulty }}
      <span class="difficulty-badge difficulty-{{ .Params.difficulty }}">{{ .Params.difficulty | title }}</span>
      {{ end }}
      <span class="tags">
        {{ range .Params.tags }}
        <span class="tag">{{ . }}</span>
        {{ end }}
      </span>
    </div>
  </header>

  <div class="article-content">
    {{ .Content }}
  </div>

  <footer class="article-footer">
    <div class="share-cta">
      <h3>Found this helpful?</h3>
      <p>Share with fellow traders or check out our other educational content.</p>
      <a href="/learn/" class="btn-secondary">More Articles</a>
    </div>

    <div class="related-articles">
      <h3>Related Topics</h3>
      <div class="related-grid">
        {{ $currentPage := . }}
        {{ $currentCategory := .Params.category | default "general" }}

        {{/* First try to get related posts from same category */}}
        {{ $sameCategoryPosts := where (where .Site.RegularPages "Section" "learn") ".Params.category" $currentCategory }}
        {{ $sameCategoryPosts = where $sameCategoryPosts ".Permalink" "ne" .Permalink }}

        {{/* If not enough same category, add from other categories */}}
        {{ $otherPosts := where (where .Site.RegularPages "Section" "learn") ".Permalink" "ne" .Permalink }}

        {{ $relatedPosts := $sameCategoryPosts }}
        {{ if lt (len $relatedPosts) 3 }}
          {{ $relatedPosts = $otherPosts }}
        {{ end }}

        {{ range first 3 $relatedPosts }}
        <a href="{{ .Permalink }}" class="related-card" data-category="{{ .Params.category | default "general" }}">
          <div class="related-card-header">
            <span class="related-icon">{{ .Params.icon | default "üìö" }}</span>
            <span class="related-category">{{ .Params.category | default "general" | title }}</span>
          </div>
          <h4>{{ .Title }}</h4>
          <p class="related-desc">{{ .Description | truncate 80 }}</p>
          <span class="read-more">Read Article ‚Üí</span>
        </a>
        {{ end }}
      </div>
    </div>
  </footer>
</article>
{{ end }}
