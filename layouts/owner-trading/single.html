{{ define "main" }}
<div class="container dashboard-page owner-trading-page">
  <!-- Auth Gate -->
  <div id="auth-gate" class="auth-gate">
    <div class="auth-card">
      <h1>Owner Trading Dashboard</h1>
      <p class="auth-warning">This area is for the site owner only.</p>
      <div class="auth-form">
        <label for="owner-secret">Owner Secret:</label>
        <input type="password" id="owner-secret" placeholder="Enter your secret key" />
        <button id="btn-authenticate" class="btn-primary">Authenticate</button>
      </div>
      <p id="auth-error" class="error-message" style="display: none;"></p>
    </div>
  </div>

  <!-- Trading Dashboard (hidden until authenticated) -->
  <div id="trading-dashboard" class="trading-dashboard" style="display: none;">
    <header class="dashboard-header">
      <h1>Personal Trading Dashboard</h1>
      <p class="subtitle">Paper trading + risk management</p>
      <button id="btn-logout" class="btn-secondary">Logout</button>
    </header>

    <!-- Risk Status Banner -->
    <section id="risk-banner" class="risk-banner">
      <div id="risk-status" class="risk-status-ok">
        <span class="risk-icon">✓</span>
        <span class="risk-text">Ready to trade</span>
      </div>
    </section>

    <!-- Quick Stats -->
    <section class="quick-stats-section">
      <div class="quick-stats-grid">
        <div class="stat-card">
          <span class="stat-label">Capital</span>
          <span class="stat-value" id="stat-capital">$100.00</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">P&L</span>
          <span class="stat-value" id="stat-pnl">$0.00</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Win Rate</span>
          <span class="stat-value" id="stat-winrate">0%</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Drawdown</span>
          <span class="stat-value" id="stat-drawdown">0%</span>
        </div>
      </div>
    </section>

    <!-- Current Signals -->
    <section class="signals-section">
      <h2>Latest Signals</h2>
      <div id="signals-container" class="signals-container">
        <p class="loading">Loading signals...</p>
      </div>
    </section>

    <!-- Paper Trade Entry -->
    <section class="trade-entry-section">
      <h2>Enter Paper Trade</h2>
      <div class="trade-form">
        <div class="form-row">
          <div class="form-group">
            <label for="trade-direction">Direction</label>
            <select id="trade-direction">
              <option value="long">Long</option>
              <option value="short">Short</option>
            </select>
          </div>
          <div class="form-group">
            <label for="trade-entry">Entry Price ($)</label>
            <input type="number" id="trade-entry" placeholder="0.00" step="0.01" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="trade-stop">Stop Loss ($) <span class="required">*</span></label>
            <input type="number" id="trade-stop" placeholder="Required" step="0.01" />
          </div>
          <div class="form-group">
            <label for="trade-target">Target ($)</label>
            <input type="number" id="trade-target" placeholder="Optional" step="0.01" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="trade-size">Position Size ($)</label>
            <input type="number" id="trade-size" placeholder="0.00" step="0.01" />
          </div>
          <div class="form-group">
            <label for="trade-strategy">Strategy</label>
            <input type="text" id="trade-strategy" placeholder="e.g., RSI oversold" />
          </div>
        </div>
        <div class="form-group full-width">
          <label for="trade-notes">Notes</label>
          <textarea id="trade-notes" placeholder="Why are you taking this trade?"></textarea>
        </div>

        <!-- Pre-trade Checklist -->
        <div class="checklist">
          <h3>Pre-Trade Checklist</h3>
          <label><input type="checkbox" id="check-sl" /> Stop loss set BEFORE entry</label>
          <label><input type="checkbox" id="check-risk" /> Risk < 2% of account</label>
          <label><input type="checkbox" id="check-reason" /> Clear entry reason</label>
          <label><input type="checkbox" id="check-revenge" /> Not revenge trading</label>
        </div>

        <div id="trade-validation" class="trade-validation" style="display: none;">
          <!-- Validation messages appear here -->
        </div>

        <button id="btn-submit-trade" class="btn-primary" disabled>
          Submit Paper Trade
        </button>
      </div>
    </section>

    <!-- Open Trades -->
    <section class="open-trades-section">
      <h2>Open Trades</h2>
      <div id="open-trades-container" class="trades-container">
        <p class="empty-state">No open trades</p>
      </div>
    </section>

    <!-- Trade History -->
    <section class="trade-history-section">
      <h2>Trade History</h2>
      <div id="trade-history-container" class="trades-container">
        <p class="empty-state">No closed trades yet</p>
      </div>
    </section>

    <!-- Risk Rules -->
    <section class="risk-rules-section">
      <h2>Risk Rules (Active)</h2>
      <div class="risk-rules-grid">
        <div class="rule">
          <span class="rule-name">Max Risk Per Trade</span>
          <span class="rule-value">2%</span>
        </div>
        <div class="rule">
          <span class="rule-name">Max Daily Loss</span>
          <span class="rule-value">5%</span>
        </div>
        <div class="rule">
          <span class="rule-name">Max Drawdown</span>
          <span class="rule-value">20%</span>
        </div>
        <div class="rule">
          <span class="rule-name">Stop After Losses</span>
          <span class="rule-value">3 in a row</span>
        </div>
      </div>
    </section>
  </div>
</div>

<style>
.owner-trading-page {
  max-width: 900px;
  padding: 2rem;
}

.auth-gate {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 60vh;
}

.auth-card {
  background: var(--bg-card, #1a1a2e);
  border-radius: 12px;
  padding: 2rem;
  max-width: 400px;
  text-align: center;
}

.auth-warning {
  color: var(--color-warning, #f59e0b);
  margin-bottom: 1.5rem;
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.auth-form input {
  padding: 0.75rem;
  border-radius: 6px;
  border: 1px solid var(--border-color, #333);
  background: var(--bg-input, #0f0f23);
  color: var(--text-color, #fff);
}

.error-message {
  color: var(--color-error, #ef4444);
  margin-top: 1rem;
}

.risk-banner {
  margin-bottom: 1.5rem;
}

.risk-status-ok {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid var(--color-success, #22c55e);
  color: var(--color-success, #22c55e);
  padding: 0.75rem 1rem;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.risk-status-warning {
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid var(--color-warning, #f59e0b);
  color: var(--color-warning, #f59e0b);
}

.risk-status-error {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid var(--color-error, #ef4444);
  color: var(--color-error, #ef4444);
}

.quick-stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--bg-card, #1a1a2e);
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
}

.stat-label {
  display: block;
  font-size: 0.875rem;
  color: var(--text-muted, #888);
}

.stat-value {
  display: block;
  font-size: 1.25rem;
  font-weight: 600;
  margin-top: 0.25rem;
}

.trade-form {
  background: var(--bg-card, #1a1a2e);
  padding: 1.5rem;
  border-radius: 12px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-size: 0.875rem;
  color: var(--text-muted, #888);
}

.form-group input,
.form-group select,
.form-group textarea {
  padding: 0.5rem;
  border-radius: 6px;
  border: 1px solid var(--border-color, #333);
  background: var(--bg-input, #0f0f23);
  color: var(--text-color, #fff);
}

.required {
  color: var(--color-error, #ef4444);
}

.checklist {
  background: var(--bg-darker, #0f0f23);
  padding: 1rem;
  border-radius: 8px;
  margin: 1rem 0;
}

.checklist h3 {
  font-size: 0.875rem;
  margin-bottom: 0.5rem;
}

.checklist label {
  display: block;
  padding: 0.25rem 0;
  cursor: pointer;
}

.trade-validation {
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.btn-primary {
  width: 100%;
  padding: 0.75rem;
  background: var(--color-primary, #f7931a);
  color: #000;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.signals-container,
.trades-container {
  background: var(--bg-card, #1a1a2e);
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
}

.risk-rules-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}

.rule {
  background: var(--bg-card, #1a1a2e);
  padding: 1rem;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
}

.rule-name {
  color: var(--text-muted, #888);
}

.rule-value {
  font-weight: 600;
}

@media (max-width: 600px) {
  .quick-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .form-row {
    grid-template-columns: 1fr;
  }
  .risk-rules-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
(function() {
  const AUTH_KEY = 'btcsai_owner_auth';
  const API_BASE = '/.netlify/functions/owner-trading';

  // Elements
  const authGate = document.getElementById('auth-gate');
  const dashboard = document.getElementById('trading-dashboard');
  const secretInput = document.getElementById('owner-secret');
  const authBtn = document.getElementById('btn-authenticate');
  const authError = document.getElementById('auth-error');
  const logoutBtn = document.getElementById('btn-logout');

  // Check for stored auth
  function checkAuth() {
    const stored = sessionStorage.getItem(AUTH_KEY);
    if (stored) {
      showDashboard();
      loadDashboard();
    }
  }

  // Authenticate
  authBtn.addEventListener('click', async () => {
    const secret = secretInput.value.trim();
    if (!secret) {
      showError('Please enter your secret key');
      return;
    }

    authBtn.disabled = true;
    authBtn.textContent = 'Authenticating...';

    try {
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Owner-Secret': secret,
        },
        body: JSON.stringify({ action: 'get_status' }),
      });

      if (res.ok) {
        sessionStorage.setItem(AUTH_KEY, secret);
        showDashboard();
        loadDashboard();
      } else {
        const data = await res.json();
        showError(data.error || 'Authentication failed');
      }
    } catch (e) {
      showError('Connection error');
    }

    authBtn.disabled = false;
    authBtn.textContent = 'Authenticate';
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem(AUTH_KEY);
    location.reload();
  });

  function showError(msg) {
    authError.textContent = msg;
    authError.style.display = 'block';
  }

  function showDashboard() {
    authGate.style.display = 'none';
    dashboard.style.display = 'block';
  }

  async function loadDashboard() {
    const secret = sessionStorage.getItem(AUTH_KEY);
    if (!secret) return;

    // Load status
    try {
      const statusRes = await fetch(API_BASE, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Owner-Secret': secret,
        },
        body: JSON.stringify({ action: 'get_status' }),
      });

      if (statusRes.ok) {
        const data = await statusRes.json();
        updateStats(data);
      }
    } catch (e) {
      console.error('Failed to load status:', e);
    }

    // Load signals
    try {
      const signalsRes = await fetch(API_BASE, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Owner-Secret': secret,
        },
        body: JSON.stringify({ action: 'get_signals' }),
      });

      if (signalsRes.ok) {
        const data = await signalsRes.json();
        updateSignals(data.signals || []);
      }
    } catch (e) {
      console.error('Failed to load signals:', e);
    }

    // Load risk status
    try {
      const riskRes = await fetch(API_BASE, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Owner-Secret': secret,
        },
        body: JSON.stringify({ action: 'get_risk_status' }),
      });

      if (riskRes.ok) {
        const data = await riskRes.json();
        updateRiskStatus(data);
      }
    } catch (e) {
      console.error('Failed to load risk status:', e);
    }
  }

  function updateStats(data) {
    const pt = data.paperTrading || {};
    document.getElementById('stat-capital').textContent = '$' + ((100 + parseFloat(pt.totalPnL || 0)).toFixed(2));
    document.getElementById('stat-pnl').textContent = '$' + (pt.totalPnL || '0.00');
    document.getElementById('stat-winrate').textContent = (pt.winRate || 0) + '%';
  }

  function updateSignals(signals) {
    const container = document.getElementById('signals-container');
    if (signals.length === 0) {
      container.innerHTML = '<p class="empty-state">No recent signals</p>';
      return;
    }

    container.innerHTML = signals.map(s => `
      <div class="signal-item ${s.direction}">
        <span class="signal-direction">${s.direction.toUpperCase()}</span>
        <span class="signal-price">$${s.priceAtSignal?.toLocaleString() || 'N/A'}</span>
        <span class="signal-confidence">${(s.confidence * 100).toFixed(0)}%</span>
        <span class="signal-time">${new Date(s.timestamp).toLocaleDateString()}</span>
      </div>
    `).join('');
  }

  function updateRiskStatus(data) {
    const banner = document.getElementById('risk-status');
    const statusEl = document.getElementById('stat-drawdown');

    if (data.metrics) {
      statusEl.textContent = data.metrics.maxDrawdown.toFixed(1) + '%';
    }

    if (data.status) {
      if (data.status.errors.length > 0) {
        banner.className = 'risk-status-error';
        banner.innerHTML = `<span class="risk-icon">⚠</span><span class="risk-text">${data.status.errors[0]}</span>`;
      } else if (data.status.warnings.length > 0) {
        banner.className = 'risk-status-warning';
        banner.innerHTML = `<span class="risk-icon">⚡</span><span class="risk-text">${data.status.warnings[0]}</span>`;
      } else {
        banner.className = 'risk-status-ok';
        banner.innerHTML = '<span class="risk-icon">✓</span><span class="risk-text">Ready to trade</span>';
      }
    }
  }

  // Trade form validation
  const checkboxes = document.querySelectorAll('.checklist input[type="checkbox"]');
  const submitBtn = document.getElementById('btn-submit-trade');

  function validateForm() {
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const hasStop = document.getElementById('trade-stop').value !== '';
    const hasEntry = document.getElementById('trade-entry').value !== '';
    const hasSize = document.getElementById('trade-size').value !== '';

    submitBtn.disabled = !(allChecked && hasStop && hasEntry && hasSize);
  }

  checkboxes.forEach(cb => cb.addEventListener('change', validateForm));
  document.getElementById('trade-stop').addEventListener('input', validateForm);
  document.getElementById('trade-entry').addEventListener('input', validateForm);
  document.getElementById('trade-size').addEventListener('input', validateForm);

  // Submit trade
  submitBtn.addEventListener('click', async () => {
    const secret = sessionStorage.getItem(AUTH_KEY);
    if (!secret) return;

    const trade = {
      direction: document.getElementById('trade-direction').value,
      entryPrice: parseFloat(document.getElementById('trade-entry').value),
      stopLoss: parseFloat(document.getElementById('trade-stop').value),
      targetPrice: parseFloat(document.getElementById('trade-target').value) || null,
      positionSize: parseFloat(document.getElementById('trade-size').value),
      strategy: document.getElementById('trade-strategy').value,
      notes: document.getElementById('trade-notes').value,
    };

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Owner-Secret': secret,
        },
        body: JSON.stringify({ action: 'paper_trade', trade }),
      });

      if (res.ok) {
        alert('Trade recorded!');
        location.reload();
      } else {
        const data = await res.json();
        alert('Error: ' + (data.error || 'Failed to record trade'));
      }
    } catch (e) {
      alert('Connection error');
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Paper Trade';
  });

  // Init
  checkAuth();
})();
</script>
{{ end }}
